<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Geolocalización - Banco Pichincha</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous"/>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
  <style>
    :root {
      --primary: #002b5c;
      --accent: #0071bc;
      --bg-light: #f4f7fa;
      --card-bg: #ffffff;
      --shadow: rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-light);
      color: var(--primary);
    }
    header {
      background: var(--primary);
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 12px var(--shadow);
    }
    header img {
      height: 60px;
      filter: brightness(0) invert(1);
      filter: none
    }
    main {
      max-width: 1280px;
      margin: 30px auto;
      padding: 0 20px;
      animation: fadeIn 0.8s ease;
    }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 16px var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
      transition: transform 0.3s;
    }
    .card:hover { transform: translateY(-5px); }
    #filterForm {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 20px;
      align-items: end;
    }

    @media (max-width: 768px) {
    /* Pasa de 4 columnas a 1 sola */
    #filterForm {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    /* Asegura que label + input queden en columna */
    #filterForm > div {
        display: flex;
        flex-direction: column;
    }

    /* Un pequeño margen entre label e input */
    #filterForm label {
        margin-bottom: 6px;
    }
        /* Apilar cada tarjeta a 100% de ancho */
    .metrics {
        flex-direction: column;
        gap: 15px;    /* ajusta el espacio vertical */
    }
    .metric-card {
        flex: 1 1 100%;
    }
    }

    #filterForm input,
    #filterForm button {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #filterForm button {
      background: var(--accent);
      color: #fff;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #filterForm button i { margin-right: 8px; }
    #message {
      text-align: center;
      color: #d9534f;
      font-weight: 500;
      margin-top: 15px;
    }
    .metrics {
      display: flex;
      gap: 20px;
      margin-top: 30px;
    }
    .metric-card {
      flex: 1;
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .metric-card::before {
      content: '';
      position: absolute;
      top: -50%; right: -50%;
      width: 200%; height: 200%;
      background: rgba(0,123,188,0.05);
      transform: rotate(45deg);
    }
    .metric-card h4 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      color: #555;
    }
    .metric-card p {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
    }
    .metric-card p i {
      font-size: 28px;
      margin-right: 10px;
      color: var(--accent);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    #map {
      display: none;
      width: 100%; height: 650px;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow);
    }
    th, td {
      padding: 14px 16px;
      font-size: 15px;
    }
    th {
      background: var(--primary);
      color: #fff;
      font-weight: 500;
    }
    tbody tr {
      transition: background 0.3s;
    }
    tbody tr:hover {
      background: rgba(0,0,0,0.03);
    }
    #downloadAllBtn, #downloadTopBtn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #downloadAllBtn:hover,
    #downloadTopBtn:hover {
      background: #005a99;
    }
  </style>
</head>
<body>
  <header>
    <!-- Logo de alta resolución (SVG/PNG) -->
    <img src="assets/logo.png" alt="Banco Pichincha" />
  </header>

  <main>
    <div class="card">
      <form id="filterForm">
        <div>
          <label for="cedula">Cédula</label>
          <input type="text" id="cedula" placeholder="1234567890" maxlength="10" />
        </div>
        <div>
          <label for="dateFrom">Fecha Desde</label>
          <input type="date" id="dateFrom" />
        </div>
        <div>
          <label for="dateTo">Fecha Hasta</label>
          <input type="date" id="dateTo" />
        </div>
        <div>
          <button type="button" id="searchBtn">
            <i class="fas fa-search"></i> Buscar
          </button>
        </div>
      </form>
      <div id="message"></div>
      <div class="metrics">
        <div class="metric-card">
          <h4>Identificación</h4>
          <p><i class="fas fa-id-card"></i><span id="cardId">--</span></p>
        </div>
        <div class="metric-card">
          <h4>Ciudad</h4>
          <p><i class="fas fa-city"></i><span id="cardCity">--</span></p>
        </div>
        <div class="metric-card">
          <h4>Último Movimiento</h4>
          <p><i class="fas fa-clock"></i><span id="cardLastMovement">--</span></p>
        </div>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-map-marked-alt"></i> Mapa de Calor (Protegido)</h3>
      <div id="map"></div>
    </div>

    <div class="card">
      <h3><i class="fas fa-chart-bar"></i> Top 3 Ciudades</h3>
      <table>
        <thead>
          <tr><th>Cédula</th><th>Ciudad</th><th>Fecha</th></tr>
        </thead>
        <tbody id="topCitiesTable"></tbody>
      </table>
      <div style="margin-top:20px; text-align:right;">
        <button id="downloadAllBtn">Descargar Completo</button>
        <button id="downloadTopBtn">Descargar Top 3</button>
      </div>
    </div>
  </main>

  <!-- JS Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
  <script>
    let rawData = [], map, heatLayer;

    Papa.parse('datos/geolocalizacion.csv', {
      download: true, header: true, dynamicTyping: true,
      complete: res => {
        rawData = res.data;
        initDates();
        initMap();
      }
    });

    function initDates() {
      if (!rawData.length) return;
      let min = Infinity, max = -Infinity;
      rawData.forEach(r => {
        const t = new Date(r.fechaHora).getTime();
        if (!isNaN(t)) {
          min = Math.min(min, t);
          max = Math.max(max, t);
        }
      });
      if (min === Infinity) return;
      const from = document.getElementById('dateFrom'),
            to   = document.getElementById('dateTo');
      const dMin = formatDate(min), dMax = formatDate(max);
      from.value = from.min = dMin; from.max = dMax;
      to.value   = dMax;   to.min   = dMin; to.max = dMax;
    }

    function initMap() {
      map = L.map('map', { minZoom: 4, maxZoom: 14 }).setView([0,0],10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OSM'
      }).addTo(map);
    }

    document.getElementById('searchBtn').addEventListener('click', () => {
      const msg = document.getElementById('message');
      msg.textContent = '';
      const ced = document.getElementById('cedula').value.trim();
      if (!/^[0-9]{6,10}$/.test(ced)) {
        msg.textContent = 'Ingrese una cédula válida.';
        return;
      }
      const from = new Date(document.getElementById('dateFrom').value),
            to   = new Date(document.getElementById('dateTo').value);
      to.setHours(23,59,59,999);

      const filtered = rawData.filter(r =>
        r.identificacionOrdenante &&
        r.geolocalizacionTransaccion &&
        r.identificacionOrdenante.toString().trim() === ced &&
        new Date(r.fechaHora) >= from &&
        new Date(r.fechaHora) <= to
      );

      if (!filtered.length) {
        msg.textContent = 'No hay datos para ese cliente.';
        document.getElementById('map').style.display = 'none';
        document.getElementById('topCitiesTable').innerHTML = '';
        return;
      }

      document.getElementById('map').style.display = 'block';

      // Esperar a que el mapa sea redimensionado antes de renderizar todo
      setTimeout(() => {
        map.invalidateSize();
        updateMetrics(filtered, ced);
        updateHeatMap(filtered);
        const top = updateTopCities(filtered, ced);
        setupDownloads(filtered, top, ced);
      }, 200);
    });

    function updateMetrics(data, ced) {
      document.getElementById('cardId').textContent = ced;
      const cnt = {}, rec = {};
      data.forEach(r => {
        cnt[r.ciudad] = (cnt[r.ciudad]||0) + 1;
        const t = new Date(r.fechaHora).getTime();
        const key = `${ced}|${r.ciudad}`;
        if (!rec[key] || t > rec[key]) rec[key] = t;
      });
      const city = Object.keys(cnt).length
        ? Object.keys(cnt).reduce((a,b) => cnt[a]>cnt[b]?a:b)
        : 'Desconocido';
      document.getElementById('cardCity').textContent = city;

      const lastTime = data.length
        ? Math.max(...data.map(r => new Date(r.fechaHora).getTime()))
        : 0;
      const diff = data.length
        ? Math.floor((Date.now() - lastTime)/(1000*60*60*24))
        : -1;
      let lt = 'Sin datos';
      if (diff >= 0) {
        lt = diff === 0
          ? 'Hoy'
          : diff === 1
            ? 'Ayer'
            : diff < 30
              ? `Hace ${diff} días`
              : `Hace más de ${Math.floor(diff/30)} meses`;
      }
      document.getElementById('cardLastMovement').textContent = lt;
    }

    function createHeatLayer(coords, opts) {
      if (typeof L.heatLayer === 'function') return L.heatLayer(coords, opts);
      if (typeof L.HeatLayer === 'function') return new L.HeatLayer(coords, opts);
      console.error('Plugin Leaflet.heat no disponible');
      return null;
    }

    function updateHeatMap(data) {
      if (heatLayer) map.removeLayer(heatLayer);
      const coords = data.map(r => {
        const [lat,lon] = r.geolocalizacionTransaccion.split(/[, ]/).map(Number);
        return (!isNaN(lat)&&!isNaN(lon)) ? [lat,lon] : null;
      }).filter(c => c);
      const avgLat = coords.reduce((s,c)=>s+c[0],0)/coords.length;
      const avgLon = coords.reduce((s,c)=>s+c[1],0)/coords.length;
      map.setView([avgLat,avgLon],10);

      const opts = {
        radius: 80,
        blur: 60,
        minOpacity: 0.6,
        max: 1.0,
        gradient: {0.2:'blue',0.4:'cyan',0.6:'lime',0.8:'orange',1.0:'red'}
      };
      const layer = createHeatLayer(coords, opts);
      if (layer) heatLayer = layer.addTo(map);
    }

    function updateTopCities(data, ced) {
      const tbody = document.getElementById('topCitiesTable');
      tbody.innerHTML = '';
      const cnt = {}, rec = {};
      data.forEach(r => {
        cnt[r.ciudad] = (cnt[r.ciudad]||0) + 1;
        const t = new Date(r.fechaHora).getTime(), key = `${ced}|${r.ciudad}`;
        if (!rec[key] || t>rec[key]) rec[key] = t;
      });
      const entries = Object.entries(cnt)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,3);
      entries.forEach(([city]) => {
        const ds = formatDate(rec[`${ced}|${city}`]);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${ced}</td><td>${city}</td><td>${ds}</td>`;
        tbody.appendChild(tr);
      });
      if (!entries.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="3">No hay datos para Top 3</td>';
        tbody.appendChild(tr);
      }
      return entries.map(([city]) => [ced, city, formatDate(rec[`${ced}|${city}`])]);
    }

    function setupDownloads(full, top, ced) {
      const mapAll = {};
      full.concat(rawData).forEach(r => {
        if (!r.identificacionOrdenante) return;
        const id = r.identificacionOrdenante.toString().trim(),
              t  = new Date(r.fechaHora).getTime(),
              key = `${id}|${r.ciudad}`;
        if (!mapAll[key] || t>mapAll[key]) mapAll[key] = t;
      });
      const csvAll = Papa.unparse([
        ['Cédula','Ciudad','Fecha más reciente'],
        ...Object.entries(mapAll).map(([k,t])=>{
          const [i,c] = k.split('|');
          return [i,c,formatDate(t)];
        })
      ]);
      document.getElementById('downloadAllBtn').onclick = () => {
        const blob = new Blob([csvAll],{type:'text/csv;charset=utf-8;'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href    = url;
        a.download= 'todos.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      const csvTop = Papa.unparse([
        ['Cédula','Ciudad','Fecha más reciente'],
        ...top
      ]);
      document.getElementById('downloadTopBtn').onclick = () => {
        const blob = new Blob([csvTop],{type:'text/csv;charset=utf-8;'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href         = url;
        a.download     = `top3_${ced}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
    }

    function formatDate(ts) {
      const d = new Date(ts),
            m = ('0'+(d.getMonth()+1)).slice(-2),
            day = ('0'+d.getDate()).slice(-2);
      return `${d.getFullYear()}-${m}-${day}`;
    }
  </script>
</body>
</html>
