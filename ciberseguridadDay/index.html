<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ciberseguridad Day</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #000;
      font-family: 'Segoe UI', sans-serif;
      touch-action: none;
    }
    canvas {
      display: block;
      max-width: 100vw;
      max-height: 100vh;
    }

    #loginUI, #finalLogo {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2;
      text-align: center;
      gap: 20px;
    }

    #loginUI {
      background: linear-gradient(to bottom, #000000cc, #000000ee),
      url('assets/background.jpg') no-repeat center center/cover;
    }

    #loginUI img {
      width: 100px;
      margin-bottom: 10px;
    }

    .logo-footer {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      z-index: 3;
    }

    #loginUI h1 {
      color: #FFD700;
      font-size: clamp(18px, 5vw, 32px);
      margin: 0;
    }

    #loginUI p {
      color: #ffffff;
      font-size: clamp(14px, 4vw, 20px);
      max-width: 90%;
    }

    #loginUI input, #loginUI button {
      padding: 12px 20px;
      font-size: clamp(14px, 4vw, 20px);
      border-radius: 8px;
      border: none;
    }

    #loginUI input {
      width: 80%;
      max-width: 300px;
    }

    #loginUI button {
      background-color: #FFD700;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }

    #loginUI button:hover {
      background-color: #e6c200;
    }

    #finalLogo {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
      pointer-events: none;
      text-align: center;
    }

    #finalLogo h2 {
      font-size: clamp(20px, 6vw, 36px);
      color: #FFD700;
    }

    #finalLogo p {
      font-size: clamp(16px, 4vw, 22px);
      color: #ffffff;
    }

    .touch-controls {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 5;
      justify-content: center;
    }

    .touch-controls button {
      padding: 10px 16px;
      font-size: clamp(16px, 5vw, 22px);
      border-radius: 10px;
      border: none;
      background-color: #FFD700;
      color: #000;
      font-weight: bold;
    }

    @media (orientation: landscape) and (max-height: 500px) {
      #loginUI h1, #loginUI p, #loginUI input, #loginUI button,
      #finalLogo h2, #finalLogo p {
        font-size: 90%;
      }
    }
  </style>
</head>
<body>

<div id="loginUI">
  <img src="assets/logo-pichincha.png" alt="Banco Pichincha">
  <h1>¬°Bienvenido a la Feria de Ciberseguridad! 2</h1>
  <p>Demuestra tu conocimiento Ciberguardi√°n en protecci√≥n digital. Supera los retos, responde las trivias y conquista la galaxia de la ciberseguridad.</p>
  <input type="text" id="usernameInput" placeholder="Ingresa tu nombre">
  <button onclick="startGame()">Comenzar misi√≥n</button>
</div>

<div id="finalLogo">
  <div style="text-align: center; color: white;">
    <h2 style="color: #FFD700; font-size: 32px; margin-bottom: 10px;">¬°MISI√ìN CUMPLIDA!</h2>
    <p style="font-size: 20px; color: #ffffff;">Has superado todos los desaf√≠os y obtuviste tu insignia Ciberguardi√°n ‚≠ê</p>
  </div>
  <canvas id="insigniaCanvas" width="500" height="500"></canvas>
</div>

<img src="assets/logo-pichincha.png" alt="Banco Pichincha" class="logo-footer">

<div class="touch-controls" id="touchControls" style="display: none;">
  <button onclick="moveLeft()">‚¨ÖÔ∏è</button>
  <button onclick="enterScene()">üöÄ</button>
  <button onclick="moveRight()">‚û°Ô∏è</button>
</div>

<script>
let userSession = {
  username: '',
  completedStages: [false, false, false]
};

let gameInstance = null;
let currentMapScene = null;

class MapScene extends Phaser.Scene {
  constructor() { super('MapScene'); }

  preload() {
    this.load.image('background', 'assets/background.jpg');
    this.load.image('module', 'assets/module.png');
    this.load.image('module-complete', 'assets/module-green.png');
    this.load.image('character', 'assets/jedi.png');
  }

  create() {
    currentMapScene = this;
    document.getElementById('finalLogo').style.display = 'none';
    document.getElementById('touchControls').style.display = 'flex';
    this.drawScene();
    this.cursors = this.input.keyboard.createCursorKeys();
    this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

    this.scale.on('resize', () => {
      this.children.removeAll();
      this.drawScene();
    });
  }

  drawScene() {
    const width = this.scale.width;
    const height = this.scale.height;
    const headerHeight = 180;
    const mapHeight = height - headerHeight;

    this.add.rectangle(width / 2, headerHeight / 2, width, headerHeight, 0x000000, 0.9);
    this.add.text(width / 2, 30, `Hola Ciberguardi√°n, ${userSession.username}`, {
      fontSize: '26px', fill: '#FFD700', fontFamily: 'Segoe UI'
    }).setOrigin(0.5);
    this.add.text(width / 2, 70, `Avanza por los m√≥dulos y demuestra tu destreza en ciberseguridad con cada misi√≥n.`, {
      fontSize: '20px', fill: '#ffffff', fontFamily: 'Segoe UI'
    }).setOrigin(0.5);
    this.add.rectangle(width / 2, headerHeight + 2, width, 4, 0x00FF00);

    const mapY = headerHeight + mapHeight / 2;
    this.add.image(width / 2, mapY, 'background').setDisplaySize(width, mapHeight);

    this.modules = [
      { x: width * 0.2, y: headerHeight + mapHeight * 0.3 },
      { x: width * 0.5, y: headerHeight + mapHeight * 0.5 },
      { x: width * 0.8, y: headerHeight + mapHeight * 0.7 }
    ];

    this.currentNode = 0;

    this.moduleSprites = this.modules.map((mod, i) => {
      const key = userSession.completedStages[i] ? 'module-complete' : 'module';
      const icon = this.add.image(mod.x, mod.y, key);
      icon.setDisplaySize(64, 64);
      this.add.text(mod.x - 20, mod.y + 40, `Fase ${i + 1}`, { fontSize: '14px', fill: '#fff' });
      return icon;
    });

    this.character = this.add.image(this.modules[0].x, this.modules[0].y - 60, 'character');
    this.character.setDisplaySize(64, 64);
  }

  update() {
    if (Phaser.Input.Keyboard.JustDown(this.cursors.right) && this.currentNode < this.modules.length - 1) {
      this.currentNode++;
      this.moveCharacter();
    } else if (Phaser.Input.Keyboard.JustDown(this.cursors.left) && this.currentNode > 0) {
      this.currentNode--;
      this.moveCharacter();
    }

    if (Phaser.Input.Keyboard.JustDown(this.enterKey)) enterScene();
  }

  moveCharacter() {
    const target = this.modules[this.currentNode];
    this.character.x = target.x;
    this.character.y = target.y - 60;
  }
}

class TriviaScene extends Phaser.Scene {
  constructor() { super('TriviaScene'); }

  init(data) {
    this.stage = data.stage;
    this.selectedOption = null;
    this.optionTexts = [];
  }

  create() {
    document.getElementById('finalLogo').style.display = 'none';
    document.getElementById('touchControls').style.display = 'none';
    this.drawTrivia();
    this.scale.on('resize', () => {
      this.children.removeAll();
      this.drawTrivia();
    });
  }

  drawTrivia() {
    const centerX = this.scale.width / 2;
    const startY = this.scale.height / 4;

    this.add.text(centerX, startY, `Trivia Fase ${this.stage}`, {
      fontSize: '26px', fill: '#FFD700', fontFamily: 'Segoe UI'
    }).setOrigin(0.5);

    this.add.text(centerX, startY + 60, '¬øQu√© es phishing?', {
      fontSize: '20px', fill: '#ffffff', fontFamily: 'Segoe UI'
    }).setOrigin(0.5);

    const opciones = [
      'Una t√©cnica para pescar',
      'Un intento de enga√±ar a usuarios para robar datos',
      'Un software antivirus'
    ];

    this.optionTexts = opciones.map((op, i) => {
      const text = this.add.text(centerX, startY + 130 + i * 50, op, {
        fontSize: '18px', fill: '#ffffff', backgroundColor: '#333',
        padding: { left: 10, right: 10, top: 5, bottom: 5 }, align: 'center'
      }).setOrigin(0.5)
        .setInteractive()
        .on('pointerdown', () => this.seleccionarOpcion(i));
      return text;
    });

    this.confirmButton = this.add.text(centerX, startY + 320, 'Responder', {
      fontSize: '20px', fill: '#000', backgroundColor: '#FFD700',
      padding: { left: 20, right: 20, top: 10, bottom: 10 }
    }).setOrigin(0.5).setInteractive().setVisible(false)
      .on('pointerdown', () => this.validarRespuesta());
  }

  seleccionarOpcion(index) {
    this.selectedOption = index;
    this.optionTexts.forEach((txt, i) => {
      txt.setStyle({
        backgroundColor: i === index ? '#FFD700' : '#333',
        fill: i === index ? '#000' : '#fff'
      });
    });
    this.confirmButton.setVisible(true);
  }

  validarRespuesta() {
    if (this.selectedOption === null) return;
    const opcion = this.optionTexts[this.selectedOption].text;
    if (opcion.includes('enga√±ar')) {
      userSession.completedStages[this.stage - 1] = true;
      const todas = userSession.completedStages.every(e => e);
      this.scene.start(todas ? 'BadgeScene' : 'MapScene');
    } else {
      this.children.getAll().forEach(child => child.destroy());
      this.drawTrivia();
      const centerX = this.scale.width / 2;
      this.add.text(centerX, this.scale.height - 80, '‚ùå Respuesta incorrecta. Intenta otra vez.', {
        fontSize: '18px', fill: '#f00'
      }).setOrigin(0.5);
      this.time.delayedCall(2500, () => this.scene.start('MapScene'));
    }
  }
}

class BadgeScene extends Phaser.Scene {
  constructor() { super('BadgeScene'); }

  create() {
    document.getElementById('finalLogo').style.display = 'flex';
    document.getElementById('touchControls').style.display = 'none';
    drawInsignia(userSession.username);
    this.scale.on('resize', () => this.scene.restart());
  }
}

function drawInsignia(nombre) {
  const canvas = document.getElementById('insigniaCanvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  img.onload = function () {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    ctx.font = 'bold 22px Segoe UI';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.fillText(nombre.toUpperCase(), canvas.width / 2, 362);
  };
  img.src = 'assets/insigniaBP.png';
}

function moveLeft() {
  if (currentMapScene && currentMapScene.currentNode > 0) {
    currentMapScene.currentNode--;
    currentMapScene.moveCharacter();
  }
}

function moveRight() {
  if (currentMapScene && currentMapScene.currentNode < 2) {
    currentMapScene.currentNode++;
    currentMapScene.moveCharacter();
  }
}

function enterScene() {
  if (currentMapScene) {
    const index = currentMapScene.currentNode;
    const unlocked = index === 0 || userSession.completedStages[index - 1];
    if (unlocked) {
      currentMapScene.scene.start('TriviaScene', { stage: index + 1 });
    }
  }
}

function startGame() {
  const username = document.getElementById('usernameInput').value;
  if (username.trim() === '') return;
  userSession.username = username;
  document.getElementById('loginUI').style.display = 'none';

  const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    backgroundColor: '#000',
    scale: {
      mode: Phaser.Scale.RESIZE,
      autoCenter: Phaser.Scale.CENTER_BOTH
    },
    scene: [MapScene, TriviaScene, BadgeScene]
  };

  gameInstance = new Phaser.Game(config);
}
</script>

</body>
</html>
