<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Construye tus Sue√±os - Banco Pichincha</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        :root {
            --banco-pichincha-gold: #FFD700;
            --banco-pichincha-gold-glow: rgba(255, 215, 0, 0.5);
            --holo-panel-bg: rgba(15, 22, 38, 0.9);
            --holo-panel-bg-header: rgba(15, 22, 38, 0.85);
            --holo-panel-border: rgba(0, 220, 255, 0.35);
            --holo-panel-border-focus: rgba(255, 215, 0, 0.7);
            --holo-text-primary: #EAEFF5;
            --holo-text-secondary: #A0B0C5;
            --holo-error-text: #FF7070;
            --holo-error-bg: rgba(255, 80, 80, 0.15);
            --holo-button-text: #0A1625;
            --sans-serif-font: 'Segoe UI', 'Roboto', Arial, Helvetica, sans-serif;
            --body-bg: #03060A;
        }

        /* --- Global Resets & Base Styles --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: var(--body-bg);
            font-family: var(--sans-serif-font);
            touch-action: none;
            color: var(--holo-text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #grupoInput,
        #emailInput,
        #passwordInput {
            width: 100%;
            padding: clamp(12px, 2.5vh, 15px) 18px;
            font-size: clamp(14px, 3vw, 16px);
            border-radius: 6px;
            border: 1px solid var(--holo-panel-border);
            background-color: rgba(5, 10, 20, 0.7);
            color: var(--holo-text-primary);
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        #grupoInput:focus,
        #emailInput:focus,
        #passwordInput:focus {
            border-color: var(--holo-panel-border-focus);
            box-shadow: 0 0 15px var(--banco-pichincha-gold-glow);
        }

        #loginButton {
            width: 100%;
            padding: clamp(12px, 2.5vh, 15px) 20px;
            font-size: clamp(15px, 3.2vw, 16px);
            border-radius: 6px;
            border: 1px solid var(--banco-pichincha-gold);
            background: var(--banco-pichincha-gold);
            color: var(--holo-button-text);
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: all 0.25s ease-in-out;
            box-shadow: 0 2px 8px rgba(255,215,0,0.2);
        }

        #phaser-game {
            position: relative;
            width: 100%;
            height: 100%;
            opacity: 1;
            transition: opacity 1.2s ease;
        }

        #phaser-game canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        /* --- Animated Background Lines --- */
        .animated-lines {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .animated-lines .line {
            position: absolute;
            background-color: rgba(0, 150, 200, 0.1);
            opacity: 0;
            animation: moveLine 15s infinite linear;
        }

        .animated-lines .line.horizontal:nth-child(1) { height: 1px; width: 200%; left: -100%; top: 10%; animation-delay: 0s; animation-duration: 10s; }
        .animated-lines .line.horizontal:nth-child(2) { height: 2px; width: 150%; left: -50%; top: 30%; animation-delay: 2s; animation-duration: 12s; }
        .animated-lines .line.horizontal:nth-child(3) { height: 1px; width: 250%; left: -150%; top: 50%; animation-delay: 4s; animation-duration: 8s;  }
        .animated-lines .line.horizontal:nth-child(4) { height: 1px; width: 180%; left: -80%; top: 70%; animation-delay: 1s; animation-duration: 15s; }
        .animated-lines .line.horizontal:nth-child(5) { height: 2px; width: 220%; left: -120%; top: 90%; animation-delay: 3s; animation-duration: 11s; }

        .animated-lines .line.vertical:nth-child(6)  { width: 1px; height: 200%; top: -100%; left: 10%; animation-name: moveLineVertical; animation-delay: 0.5s; animation-duration: 13s; }
        .animated-lines .line.vertical:nth-child(7)  { width: 2px; height: 150%; top: -50%; left: 30%; animation-name: moveLineVertical; animation-delay: 2.5s; animation-duration: 9s;  }
        .animated-lines .line.vertical:nth-child(8)  { width: 1px; height: 250%; top: -150%; left: 50%; animation-name: moveLineVertical; animation-delay: 4.5s; animation-duration: 14s; }
        .animated-lines .line.vertical:nth-child(9)  { width: 1px; height: 180%; top: -80%; left: 70%; animation-name: moveLineVertical; animation-delay: 1.5s; animation-duration: 10s; }
        .animated-lines .line.vertical:nth-child(10) { width: 2px; height: 220%; top: -120%; left: 90%; animation-name: moveLineVertical; animation-delay: 3.5s; animation-duration: 12s; }

        @keyframes moveLine {
            0% { transform: translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        @keyframes moveLineVertical {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        @keyframes fadeInHoloPanel {
            from { opacity: 0; transform: perspective(1000px) rotateY(-5deg) scale(0.9); }
            to { opacity: 1; transform: perspective(1000px) rotateY(0deg) scale(1); }
        }

        /* --- Login UI --- */
        #loginUI {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30;
            box-sizing: border-box;
            padding: 20px;
            overflow: hidden;
        }

        #holographicPanel {
            position: relative;
            z-index: 2;
            background: linear-gradient(145deg, rgba(10, 22, 38, 0.9), rgba(20, 32, 58, 0.95));
            padding: clamp(30px, 5vw, 40px);
            border-radius: 10px;
            border: 1px solid var(--holo-panel-border);
            box-shadow: 0 0 35px rgba(0, 180, 255, 0.1), 0 0 15px rgba(0,180,255,0.1) inset;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(18px, 3vh, 22px);
            animation: fadeInHoloPanel 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            transform-style: preserve-3d;
        }

        .holo-logo {
            width: clamp(100px, 18vw, 120px);
            height: auto;
            margin-bottom: clamp(5px, 1.5vh, 10px);
        }

        .holo-title {
            color: var(--banco-pichincha-gold);
            font-size: clamp(20px, 5vw, 24px);
            font-weight: 600;
            margin: 0;
            text-shadow: 0 0 12px var(--banco-pichincha-gold-glow);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .holo-subtitle {
            color: var(--holo-text-secondary);
            font-size: clamp(13px, 2.5vw, 15px);
            max-width: 90%;
            margin: -12px 0 0 0;
            line-height: 1.5;
            text-align: center;
        }

        /* --- Fullscreen UI Panel (Base for Trivia, Final Badge) --- */
        .fullscreen-ui-panel {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            padding: 20px;
            box-sizing: border-box;
            background-color: var(--body-bg);
        }

        .panel-content-wrapper {
            background: var(--holo-panel-bg);
            padding: clamp(25px, 4vw, 35px);
            border-radius: 10px;
            border: 1px solid var(--holo-panel-border);
            box-shadow: 0 0 25px rgba(0, 180, 255, 0.1), 0 0 10px rgba(0,180,255,0.05) inset;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(15px, 2.5vh, 20px);
            animation: fadeInHoloPanel 0.6s cubic-bezier(0.23, 1, 0.32, 1) 0.1s forwards;
            opacity: 0;
        }

        .panel-content-wrapper .panel-header-title {
            color: var(--banco-pichincha-gold);
            font-size: clamp(18px, 4.5vw, 22px);
            font-weight: 600;
            margin: 0 0 10px 0;
            text-shadow: 0 0 10px var(--banco-pichincha-gold-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .panel-content-wrapper .panel-text {
            color: var(--holo-text-primary);
            font-size: clamp(14px, 3vw, 16px);
            line-height: 1.6;
            text-align: center;
            max-width: 90%;
        }

        .panel-button {
            padding: clamp(10px, 2vh, 12px) clamp(20px, 4vw, 25px);
            font-size: clamp(14px, 3vw, 15px);
            border-radius: 6px;
            border: 1px solid var(--banco-pichincha-gold);
            background: var(--banco-pichincha-gold);
            color: var(--holo-button-text);
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.25s ease-in-out;
            box-shadow: 0 2px 6px rgba(255,215,0,0.15);
        }

        .panel-button:hover {
            background: #FFDF30;
            box-shadow: 0 0 15px var(--banco-pichincha-gold-glow);
            transform: translateY(-1px);
        }

        /* --- Map Specific UI --- */
        #mapHeader {
            position: absolute; top: 0; left: 0;
            width: 100%;
            padding: clamp(8px, 1.5vh, 12px) 15px;
            /*box-sizing: border-box;*/
            text-align: center;
            z-index: 10;
            background: var(--holo-panel-bg-header);
            border-bottom: 1px solid var(--holo-panel-border);
            /*box-shadow: 0 2px 15px rgba(0, 150, 200, 0.1);*/
        }

        #mapTitle {
            color: var(--banco-pichincha-gold);
            font-size: clamp(14px, 2.5vw, 18px);
            font-weight: 600;
            margin: 0 0 2px 0;
            text-shadow: 0 0 8px var(--banco-pichincha-gold-glow);
        }

        #mapDescription {
            color: var(--holo-text-secondary);
            font-size: clamp(11px, 2vw, 13px);
            margin: 0 auto;
            text-align: center;
            max-width: 80%; /* evita que el texto se pegue a los bordes */
            line-height: 1.5;
        }

        #mapModuleTextsContainer {
            position: absolute; top:0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .map-module-text {
            position: absolute;
            transform: translateX(-50%);
            color: var(--holo-text-secondary);
            font-size: clamp(9px, 1.8vw, 11px);
            text-align: center;
            padding: 3px 6px;
            background-color: rgba(10, 22, 38, 0.7);
            border-radius: 3px;
            text-shadow: 0 0 3px #000;
            border: 1px solid rgba(0, 150, 200, 0.15);
        }

        .map-module-text.completed { color: #60FF60; }
        .map-module-text.active    { color: var(--banco-pichincha-gold); font-weight: 600; }

        /* --- Trivia UI Specifics --- */
        #triviaOptionsContainer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 450px;
        }

        .trivia-option {
            font-size: clamp(13px, 2.8vw, 15px);
            color: var(--holo-text-primary);
            background-color: rgba(25, 40, 65, 0.7);
            padding: clamp(10px, 2vh, 14px) 15px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--holo-panel-border);
            transition: background-color 0.2s, border-color 0.2s, transform 0.15s;
            text-align: left;
        }

        .trivia-option:hover {
            background-color: rgba(35, 50, 80, 0.8);
            border-color: var(--banco-pichincha-gold);
            transform: scale(1.02);
        }

        .trivia-option.selected {
            background-color: var(--banco-pichincha-gold);
            color: var(--holo-button-text);
            font-weight: 600;
            border-color: var(--banco-pichincha-gold);
        }

        #triviaIncorrectMessage {
            font-size: clamp(13px, 2.5vw, 14px);
            color: var(--holo-error-text);
            background-color: var(--holo-error-bg);
            padding: 10px 12px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px solid var(--holo-error-text);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
            text-align: center;
        }

        /* --- Final Badge/Logo UI Specifics --- */
        #insigniaCanvas {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative;
            z-index: 10;
        }

        /* --- Bottom Bar / Touch Controls --- */
        #bottomBarContainer {
            position: fixed; bottom: 0; left: 0;
            width: 100%;
            background-color: rgba(10, 22, 38, 0.9);
            z-index: 25;
            flex-direction: column;
            align-items: center;
            border-top: 1px solid var(--holo-panel-border);
            box-shadow: 0 -2px 15px rgba(0, 150, 200, 0.1);
        }

        .touch-controls {
            width: 100%;
            box-sizing: border-box;
            padding: clamp(8px, 1.5vh, 10px) 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .insignia-img {
            display: block;
            max-width: 80%;
            max-height: 60%;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .touch-controls button {
            padding: clamp(8px, 1.8vh, 10px) clamp(12px, 2.5vw, 16px);
            font-size: clamp(16px, 4vw, 20px);
            border-radius: 6px;
            border: 1px solid var(--banco-pichincha-gold);
            background-color: var(--banco-pichincha-gold);
            color: var(--holo-button-text);
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(255,215,0,0.2);
            transition: all 0.2s ease-in-out;
        }

        .touch-controls button:hover {
            background-color: #FFDF30;
            box-shadow: 0 0 10px var(--banco-pichincha-gold-glow);
            transform: scale(1.05);
        }

        .touch-controls button:active {
            transform: scale(1);
        }

        .logo-footer {
            width: clamp(45px, 10vw, 50px);
            height: auto;
            margin-top: 5px;
            margin-bottom: clamp(5px, 1vh, 8px);
            opacity: 0.8;
        }

        /* --- Module Info UI (ESTILOS ID√âNTICOS A TRIVIA) --- */
        #moduleInfoUI {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 100vw;
            height: auto;
            z-index: 20;
            padding: 20px;
            box-sizing: border-box;
            background: none;
        }

        /* --- Module Info UI - Versi√≥n Corregida --- */
        #moduleInfoUI .panel-content-wrapper {
            background: var(--holo-panel-bg);
            padding: clamp(25px, 4vw, 35px);
            border-radius: 0px;
            border: 0px solid var(--holo-panel-border); /* Borde azul */
            box-shadow: 0 0 35px rgba(0, 180, 255, 0.1), 
                        0 0 15px rgba(0, 180, 255, 0.1) inset;
            width: calc(100% - 40px); /* Ajuste para padding */
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(18px, 3vh, 22px);
            animation: fadeInHoloPanel 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            transform-style: preserve-3d;
            /* Correcci√≥n de centrado: */
            margin: 0 auto;
            position: relative;
            left: 0;
            transform: none;
        }

        #moduleInfoTitle {
            color: var(--banco-pichincha-gold);
            font-size: clamp(20px, 5vw, 24px);
            font-weight: 600;
            margin: 0 0 clamp(5px, 1.5vh, 10px) 0;
            text-shadow: 0 0 12px var(--banco-pichincha-gold-glow);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-align: center;
        }

        #moduleInfoDescription {
            color: var(--holo-text-primary);
            font-size: clamp(14px, 3vw, 16px);
            line-height: 1.6;
            text-align: center;
            width: 100%;
            max-width: 90%;
            margin: 0;
            padding: 0 clamp(10px, 2vw, 15px);
            box-sizing: border-box;
        }

        .module-info-divider {
            width: 80%;
            height: 1px;
            background: linear-gradient(90deg, 
                    transparent 0%, 
                    var(--holo-panel-border) 20%, 
                    var(--holo-panel-border) 80%, 
                    transparent 100%);
            margin: clamp(5px, 1vh, 10px) 0;
        }

        #startTriviaButton {
            width: 100%;
            max-width: 450px;
            padding: clamp(12px, 2.5vh, 15px) 20px;
            font-size: clamp(15px, 3.2vw, 16px);
            border-radius: 6px;
            border: 1px solid var(--banco-pichincha-gold);
            background: var(--banco-pichincha-gold);
            color: var(--holo-button-text);
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: all 0.25s ease-in-out;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.2);
            text-align: center;
        }
        #loginButton:hover,
        #startTriviaButton:hover {
            background: #FFDF30;
            box-shadow: 0 0 20px var(--banco-pichincha-gold-glow), 
                        0 0 10px var(--banco-pichincha-gold);
            transform: translateY(-2px) scale(1.02);
        }

        #solarIntro {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #0a0f1f 0%, #01040a 100%);
            z-index: 100;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .planet-container {
            position: relative;
            width: 300px;
            height: 300px;
            animation: rotateSolar 10s linear infinite;
        }

        .planet {
            position: absolute;
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .planet0 { top: 0; left: 50%; transform: translateX(-50%); }
        .planet1 { top: 25%; left: 90%; transform: translate(-50%, -50%); }
        .planet2 { bottom: 0; left: 50%; transform: translateX(-50%); }
        .planet3 { top: 75%; left: 10%; transform: translate(-50%, -50%); }
        .planet4 { top: 10%; left: 10%; transform: translate(-50%, -50%); }
        .planet5 { bottom: 10%; right: 10%; transform: translate(50%, 50%); }
        .planet6 { top: 50%; left: 0; transform: translateY(-50%); }
        .planet7 { top: 50%; right: 0; transform: translateY(-50%); }

        @keyframes rotateSolar {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #introText {
            text-align: center;
            color: white;
            margin-top: 20px;
            animation: fadeText 6s ease-out forwards;
        }

        #introText h1 {
            font-size: clamp(24px, 5vw, 40px);
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00eaff;
        }
        #introText p {
            font-size: clamp(16px, 3vw, 24px);
            color: #cccccc;
        }

        @keyframes fadeText {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        #solarIntro {
            opacity: 1;
            transition: opacity 1.2s ease;
        }

        #loginUI {
            opacity: 0;
            transition: opacity 1.2s ease;
        }

        /* Media Queries ID√âNTICOS a los de trivia */
        @media (max-width: 600px) {
            #moduleInfoUI .panel-content-wrapper {
                max-width: calc(100% - 40px);
                padding: clamp(20px, 5vw, 25px);
            }
            #moduleInfoTitle {
                font-size: clamp(18px, 5vw, 22px);
            }
            #moduleInfoDescription {
                font-size: clamp(13px, 3vw, 15px);
            }
            #startTriviaButton {
                font-size: clamp(14px, 3.2vw, 15px);
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #moduleInfoUI .panel-content-wrapper {
                max-width: 500px;
                padding: clamp(15px, 3vw, 25px);
                gap: clamp(10px, 2vh, 15px);
            }
        }

        /* --- Media Queries --- */
        @media (max-width: 600px) {
            .panel-content-wrapper {
                max-width: calc(100% - 20px); 
            }
            
            .holo-title { font-size: clamp(18px, 5vw, 22px); }
            .holo-subtitle { font-size: clamp(12px, 2.5vw, 14px); }
            #grupoInput, #emailInput, #passwordInput { font-size: clamp(13px, 3vw, 15px); }
            #loginButton { font-size: clamp(14px, 3.2vw, 15px); }
            .map-module-text { font-size: clamp(8px, 1.8vw, 10px); }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .panel-content-wrapper {
                max-width: 500px; 
                padding: clamp(15px, 3vw, 25px); 
                gap: clamp(10px, 2vh, 15px);    
            }
            #mapHeader {
                padding: clamp(6px, 1vh, 10px) 10px;
            }
            .touch-controls button {
                 padding: clamp(6px, 1.5vh, 8px) clamp(10px, 2vw, 14px);
                 font-size: clamp(14px, 3.5vw, 18px);
            }
        }

        @media (max-height: 700px) and (orientation: portrait) {
            .touch-controls { padding: clamp(5px, 1vh, 8px) 0; }
            .logo-footer { width: clamp(35px, 8vw, 40px); margin-bottom: clamp(3px, 0.5vh, 5px); }
        }

        .module-speakers {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .module-speakers-title {
            font-size: clamp(16px, 4vw, 18px);
            color: var(--banco-pichincha-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .module-speakers-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }

        .speaker-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 100px;
        }

        .speaker-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            border: 2px solid var(--banco-pichincha-gold);
        }

        .speaker-name {
            color: var(--holo-text-primary);
            font-weight: 600;
            margin-top: 8px;
            font-size: 14px;
        }

        .speaker-role {
            color: var(--holo-text-secondary);
            font-size: 12px;
        }

    </style>
</head>
<body>
    <div id="solarIntro">
    <div class="planet-container">
        <img src="assets/module0.png" class="planet planet0">
        <img src="assets/module1.png" class="planet planet1">
        <img src="assets/module2.png" class="planet planet2">
        <img src="assets/module3.png" class="planet planet3">
        <img src="assets/module4.png" class="planet planet4">
        <img src="assets/module5.png" class="planet planet5">
        <img src="assets/module6.png" class="planet planet6">
        <img src="assets/module7.png" class="planet planet7">
    </div>
    <div id="introText">
        <h1>Protege lo que construyes</h1>
        <p>Tus decisiones hoy aseguran tu futuro ma√±ana.</p>
    </div>
    </div>

    <div id="phaser-game">
        <div class="animated-lines">
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
        </div>
    </div>
    
    <div id="loginUI">
        <div class="animated-lines">
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
        </div>
        <div id="holographicPanel">
            <img src="assets/logo-pichincha.png" alt="Logo Banco Pichincha" class="holo-logo">
            <h1 class="holo-title">Protege tus Sue√±os</h1>
            <p class="holo-subtitle">Tu contrase√±a segura es la llave que cuida tus metas, tus planes, tu futuro.</p>

            <div class="holo-input-group">
                <input type="number" id="grupoInput" placeholder="Grupo (n√∫mero)" aria-label="Grupo" min="1" required>
            </div>

            <div class="holo-input-group">
                <input type="email" id="emailInput" placeholder="Correo Electr√≥nico" aria-label="Correo Electr√≥nico" required>
            </div>

            <div class="holo-input-group">
                <input type="password" id="passwordInput" placeholder="Contrase√±a" aria-label="Contrase√±a" required>
            </div>

            <p id="loginError" style="display: none; color: var(--holo-error-text); text-align: center; font-size: 0.9rem;"></p>

            <button id="loginButton">Acceder</button>
        </div>
    </div>

    <div id="mapHeader" class="hidden">
        <div id="mapTitle"></div>
        <div id="mapDescription"></div>
    </div>
    <div id="mapModuleTextsContainer" class="hidden"></div>
    
    <div id="moduleInfoUI" class="fullscreen-ui-panel hidden">
        <div class="panel-content-wrapper">
            <h2 id="moduleInfoTitle" class="panel-header-title"></h2>
            <div class="panel-text-content">
                <p id="moduleInfoDescription" class="panel-text"></p>
                <div class="module-info-divider"></div>
            </div>
            <div id="moduleSpeakersContainer" class="module-speakers hidden">
                <h3 class="module-speakers-title">Expositores</h3>
                <div class="module-speakers-list" id="speakersList"></div>
            </div>
            <button id="startTriviaButton" class="panel-button">INICIAR TRIVIA</button>
        </div>
    </div>

    <div id="triviaUI" class="fullscreen-ui-panel hidden">
        <div class="animated-lines">
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
        </div>
        <div class="panel-content-wrapper">
            <h2 id="triviaTitle" class="panel-header-title">Desaf√≠o de Ciberseguridad</h2>
            <p id="triviaQuestion" class="panel-text">Cargando pregunta...</p>
            <div id="triviaOptionsContainer"></div>
            <button id="triviaConfirmButton" class="panel-button hidden">Responder</button>
            <p id="triviaIncorrectMessage" class="hidden"></p>
        </div>
    </div>

    <div id="finalLogo" class="fullscreen-ui-panel hidden">
        <div class="animated-lines">
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line horizontal"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
            <div class="line vertical"></div>
        </div>
         <div class="panel-content-wrapper">
            <h2 class="panel-header-title">¬°MISI√ìN CUMPLIDA!</h2>
            <p class="panel-text">Has superado todos los desaf√≠os y obtuviste tu insignia Ciberguardi√°n ‚≠ê</p>
             <img id="insigniaImage" class="insignia-img" alt="Insignia de Ciberguardi√°n completada">
        </div>
    </div>

    <div id="bottomBarContainer" class="hidden">
        <div class="touch-controls" id="touchControls">
            <button id="moveLeftButton" aria-label="Mover a la izquierda">‚¨ÖÔ∏è</button>
            <button id="enterSceneButton" aria-label="Acceder a misi√≥n">üî®</button>
            <button id="moveRightButton" aria-label="Mover a la derecha">‚û°Ô∏è</button>
        </div>
        <img src="assets/logo-pichincha.png" alt="Logo Banco Pichincha pie de p√°gina" class="logo-footer" id="logoFooter">
    </div>


    <script>
        // ==================== CONSTANTS AND CONFIGURATION ====================
        const GLOBAL_CONFIG = {
            FONT_FAMILY_HTML: 'Segoe UI, Arial, sans-serif',
            MODULE_COUNT: 8,
            ASSETS_PATH: 'assets/',
            TRIVIA_QUESTIONS: [
                {
                    id: 0,
                    title: "La llave de tus sue√±os",
                    description: "Una contrase√±a segura no solo protege tu cuenta‚Ä¶ protege tus ahorros, tus ideas, tu futuro. Cada car√°cter es una barrera que aleja a quien quiera arrebat√°rtelo.",
                    question: "¬øCu√°l de las siguientes es una contrase√±a m√°s segura: '123456' o 'P@$$wOrd2025!'?",
                    options: ["123456", "P@$$wOrd2025!"],
                    correctAnswerIndex: 1,
                    speakers: [
                    { name: "Ana Torres", role: "Especialista en Seguridad", img: "ana.png" },
                    { name: "Carlos Rivas", role: "Hacker √âtico", img: "carlos.png" },
                    { name: "Laura Mej√≠a", role: "Consultora en Riesgos Digitales", img: "laura.png" }
                    ]
                },
                {
                    id: 1,
                    title: "Cuidado con lo que muerdes",
                    description: "A veces, lo que brilla en tu bandeja no es una oportunidad, es un anzuelo. Y si lo muerdes, pueden robarte m√°s que datos: tu tranquilidad.",
                    question: "El 'phishing' es un intento de adquirir informaci√≥n confidencial de forma fraudulenta. ¬øVerdadero o Falso?",
                    options: ["Verdadero", "Falso"],
                    correctAnswerIndex: 0,
                    speakers: [
                    { name: "Javier Mendoza", role: "Analista de Ciberseguridad", img: "javier.png" }
                    ]
                },
                {
                    id: 2,
                    title: "Gotas que vac√≠an tu futuro",
                    description: "No todo se pierde de golpe. A veces, es gota a gota. Cada dato que entregas sin cuidado es una filtraci√≥n en el barco de tus metas.",
                    question: "¬øCu√°l es la mejor pr√°ctica para prevenir fugas de informaci√≥n en Banco Pichincha?",
                    options: [
                    "Compartir documentos confidenciales por WhatsApp",
                    "Usar solo redes p√∫blicas para transferencias",
                    "Cifrar archivos sensibles y usar canales autorizados"
                    ],
                    correctAnswerIndex: 2,
                    speakers: []
                },
                {
                    id: 3,
                    title: "No todo lo que ves es real",
                    description: "Una sonrisa en video. Una voz familiar. Pero todo fue creado. Las mentiras digitales pueden poner en riesgo decisiones reales.",
                    question: "Recibes un video del gerente pidiendo una transferencia urgente. ¬øQu√© haces?",
                    options: [
                    "Ejecuto la transferencia inmediatamente",
                    "Verifico la solicitud por otro canal oficial",
                    "Reenv√≠o el video al departamento de TI"
                    ],
                    correctAnswerIndex: 1,
                    speakers: [
                    { name: "Luisa Prado", role: "Experta en Ingenier√≠a Social", img: "luisa.png" }
                    ]
                },
                {
                    id: 4,
                    title: "Verdades a medias, riesgos enteros",
                    description: "No todo lo que lees te informa. A veces, te confunde, te manipula y te aleja de lo correcto. La desinformaci√≥n tambi√©n es una amenaza silenciosa.",
                    question: "¬øC√≥mo identificar una wiki falsa?",
                    options: [
                    "URLs con errores ortogr√°ficos (ej: wikipediia.org)",
                    "Certificado SSL v√°lido",
                    "Logotipo oficial en la p√°gina"
                    ],
                    correctAnswerIndex: 0,
                    speakers: []
                },
                {
                    id: 5,
                    title: "Cuando la promesa es la trampa",
                    description: "El sue√±o de ganar r√°pido, de obtener m√°s... puede ser el disfraz perfecto de una p√©rdida segura. Aprende a distinguir valor de enga√±o.",
                    question: "Te ofrecen un premio solicitando datos bancarios. ¬øEs seguro?",
                    options: [
                    "S√≠, si el premio es de Banco Pichincha",
                    "Solo si piden CVV de la tarjeta",
                    "Nunca, el banco no solicita datos as√≠"
                    ],
                    correctAnswerIndex: 2,
                    speakers: [
                    { name: "Marcos Ibarra", role: "Investigador de Fraudes Digitales", img: "assets/marcos.png" }
                    ]
                },
                {
                    id: 6,
                    title: "Cuando el riesgo no es virtual... es real",
                    description: "Tus datos pueden llevar a alguien hasta ti. La seguridad digital es seguridad f√≠sica. El da√±o no siempre es en l√≠nea.",
                    question: "Si detectas un ataque de ransomware, ¬øqu√© haces primero?",
                    options: [
                    "Pagar el rescate",
                    "Desconectar equipos de la red",
                    "Reiniciar los servidores"
                    ],
                    correctAnswerIndex: 1,
                    speakers: []
                },
                {
                    id: 7,
                    title: "El futuro no se adivina, se protege",
                    description: "Las amenazas cambian. Lo que hoy parece seguro, ma√±ana puede ser vulnerable. La mejor forma de anticiparse‚Ä¶ es estar siempre preparado.",
                    question: "¬øC√≥mo protegerte del ciberadivinador?",
                    options: [
                    "Usar informaci√≥n real en preguntas de seguridad",
                    "Crear respuestas ficticias no adivinables",
                    "Compartir menos en redes sociales"
                    ],
                    correctAnswerIndex: 2,
                    speakers: [
                    { name: "Diana L√≥pez", role: "Consultora en Privacidad", img: "assets/diana.png" }
                    ]
                }
            ],
            GOOGLE_SHEETS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxp8p0CJDDpkWvPIZboo3BTM09e93VkTo0icH1f0nwG46uI9GaqvdX99UqxEGQaZC55/exec'
        };

        // ==================== GLOBAL STATE ====================
        const state = {
            gameInstance: null,
            currentMapSceneRef: null,
            startTime: Date.now(),
            loginAttempts: 0,
            userSession: {
                email: '',
                grupo: '',
                completedStages: Array(GLOBAL_CONFIG.MODULE_COUNT).fill(false)
            },
            triviaStartTimes: Array(GLOBAL_CONFIG.MODULE_COUNT).fill(0),
            triviaResponseTimes: Array(GLOBAL_CONFIG.MODULE_COUNT).fill(0),
            totalTriviaTime: 0
        };

        // ==================== DOM ELEMENTS ====================
        const DOM_ELEMENTS = {
            phaserGameContainer: document.getElementById('phaser-game'),
            loginUI: document.getElementById('loginUI'),
            grupoInput: document.getElementById('grupoInput'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginButton: document.getElementById('loginButton'),
            loginError: document.getElementById('loginError'),
            mapHeader: document.getElementById('mapHeader'),
            mapTitle: document.getElementById('mapTitle'),
            mapDescription: document.getElementById('mapDescription'),
            mapModuleTextsContainer: document.getElementById('mapModuleTextsContainer'),
            triviaUI: document.getElementById('triviaUI'),
            triviaTitle: document.getElementById('triviaTitle'),
            triviaQuestion: document.getElementById('triviaQuestion'),
            triviaOptionsContainer: document.getElementById('triviaOptionsContainer'),
            triviaConfirmButton: document.getElementById('triviaConfirmButton'),
            triviaIncorrectMessage: document.getElementById('triviaIncorrectMessage'),
            finalLogoUI: document.getElementById('finalLogo'),
            insigniaCanvas: document.getElementById('insigniaCanvas'),
            bottomBarContainer: document.getElementById('bottomBarContainer'),
            moveLeftButton: document.getElementById('moveLeftButton'),
            enterSceneButton: document.getElementById('enterSceneButton'),
            moveRightButton: document.getElementById('moveRightButton')
        };

        // ==================== UTILITY FUNCTIONS ====================
        function manageUIContainersVisibility(elementsToShow = []) {
            const ALL_MAIN_UI_IDS = ['loginUI', 'mapHeader', 'mapModuleTextsContainer', 
                            'triviaUI', 'finalLogoUI', 'bottomBarContainer', 'moduleInfoUI'];
            ALL_MAIN_UI_IDS.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (elementsToShow.includes(id)) {
                        element.style.display = (id === 'loginUI' || id === 'triviaUI' || id === 'finalLogoUI' || id === 'bottomBarContainer') ? 'flex' : 'block';
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                }
            });
        }

        function createStandardSceneBackground(scene) {
            if (scene.bgStandard) scene.bgStandard.destroy();
            if (scene.overlayStandard) scene.overlayStandard.destroy();

            // scene.bgStandard = scene.add.image(scene.scale.width / 2, scene.scale.height / 2, 'background')
            //     .setDisplaySize(scene.scale.width, scene.scale.height)
            //     .setDepth(-1);
            
            scene.overlayStandard = scene.add.rectangle(0, 0, scene.scale.width, scene.scale.height, 0x000000, 0.75)
                .setOrigin(0)
                .setDepth(-0.5);

            const resizeHandler = () => {
                if (scene.bgStandard?.active) {
                    scene.bgStandard.setPosition(scene.scale.width / 2, scene.scale.height / 2)
                                   .setDisplaySize(scene.scale.width, scene.scale.height);
                }
                if (scene.overlayStandard?.active) {
                    scene.overlayStandard.setSize(scene.scale.width, scene.scale.height);
                }
            };
            
            scene.scale.on('resize', resizeHandler, scene);
            scene.sys.events.once('shutdown', () => {
                scene.scale.off('resize', resizeHandler, scene);
                if (scene.bgStandard) { scene.bgStandard.destroy(); scene.bgStandard = null; }
                if (scene.overlayStandard) { scene.overlayStandard.destroy(); scene.overlayStandard = null; }
            }, scene);
        }

        function createMapFocusedBackground(scene) {
            if (scene.mapFocusedBg) scene.mapFocusedBg.destroy();
            if (scene.mapFocusedOverlay) scene.mapFocusedOverlay.destroy();

            // scene.mapFocusedBg = scene.add.image(scene.scale.width / 2, scene.scale.height / 2, 'background')
            //     .setDisplaySize(scene.scale.width, scene.scale.height)
            //     .setDepth(-2)
            //     .setTint(0x333333);

            scene.mapFocusedOverlay = scene.add.rectangle(0, 0, scene.scale.width, scene.scale.height, 0x03060A, 0.6)
                .setOrigin(0)
                .setDepth(-1);

            const resizeHandler = () => {
                if (scene.mapFocusedBg?.active) {
                    scene.mapFocusedBg.setPosition(scene.scale.width / 2, scene.scale.height / 2)
                                      .setDisplaySize(scene.scale.width, scene.scale.height);
                }
                if (scene.mapFocusedOverlay?.active) {
                    scene.mapFocusedOverlay.setSize(scene.scale.width, scene.scale.height);
                }
            };
            
            scene.scale.on('resize', resizeHandler, scene);
            scene.sys.events.once('shutdown', () => {
                scene.scale.off('resize', resizeHandler, scene);
                if (scene.mapFocusedBg) { scene.mapFocusedBg.destroy(); scene.mapFocusedBg = null; }
                if (scene.mapFocusedOverlay) { scene.mapFocusedOverlay.destroy(); scene.mapFocusedOverlay = null; }
            }, scene);
        }

        // ==================== SCENE CLASSES ====================
        class MapScene extends Phaser.Scene {
            constructor() {
                super('MapScene');
                this.moduleSprites = [];
                this.htmlModuleTextElements = [];
                this.activeModuleEffects = { border: null, scanline: null, scanlineTween: null };
                this.character = null;
                this.currentNode = 0;
                this.modulePositions = [];
                this.isLandscape = false;
                this.cursors = null;
                this.enterKey = null;
                this.connectionGraphics = null;
                this.letterConnections = [
                    [0,1], [1,2], [2,3],   // C
                    [3,4], [4,5], [5,6]    // S
                ];
            }

            preload() {
                for (let i = 0; i < GLOBAL_CONFIG.MODULE_COUNT; i++) {
                    const suffix = window.devicePixelRatio > 1.5 ? '@2x' : '';
                    this.load.image(`module${i}`, `${GLOBAL_CONFIG.ASSETS_PATH}module${i}.png`);
                }
                this.load.image('character', `${GLOBAL_CONFIG.ASSETS_PATH}jedi.png`);
            }

            create() {
                state.currentMapSceneRef = this;
                manageUIContainersVisibility(['mapHeader', 'mapModuleTextsContainer', 'bottomBarContainer']);
                createMapFocusedBackground(this);

                //this.activeModuleEffects.border = this.add.graphics().setDepth(1);
                this.activeModuleEffects.scanline = this.add.graphics().setDepth(3);
                this.connectionGraphics = this.add.graphics().setDepth(0);

                this.drawSceneElements();
                this.cursors = this.input.keyboard.createCursorKeys();
                this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

                this.scale.on('resize', this.handleResize, this);
                this.updateModuleTextPositions();
                this.updateActiveModuleVisuals();
                this.drawConnections();
            }

            handleResize() {
                this.moduleSprites.forEach(spriteGroup => { 
                    if (spriteGroup.icon) spriteGroup.icon.destroy(); 
                });
                this.moduleSprites = [];
                
                if (DOM_ELEMENTS.mapModuleTextsContainer) {
                    DOM_ELEMENTS.mapModuleTextsContainer.innerHTML = '';
                }
                this.htmlModuleTextElements = [];

                if (this.character) this.character.destroy();
                if (this.activeModuleEffects.border) this.activeModuleEffects.border.clear();
                if (this.activeModuleEffects.scanline) this.activeModuleEffects.scanline.clear();
                if (this.connectionGraphics) this.connectionGraphics.clear();
                
                if (this.activeModuleEffects.scanlineTween?.isPlaying()) {
                    this.activeModuleEffects.scanlineTween.stop();
                }
                
                this.drawSceneElements();
                this.updateModuleTextPositions();
                this.updateActiveModuleVisuals();
                this.drawConnections();
            }

            drawSceneElements() {
                const { width, height } = this.scale;
                this.isLandscape = width > height;

                if (DOM_ELEMENTS.mapTitle && state.userSession.email) {
                    DOM_ELEMENTS.mapTitle.textContent = `Protege lo que construyes.`;
                }

                if (DOM_ELEMENTS.mapDescription) {
                    DOM_ELEMENTS.mapDescription.textContent = `Tus metas no viven en un mundo aislado. Cada contrase√±a, cada clic, cada dato‚Ä¶ es un ladrillo m√°s en la casa de tus sue√±os. Pero hay amenazas que pueden derrumbar todo si no est√°s atento.`;
                }

                const headerHeightPercentage = this.isLandscape ? 0.1 : 0.08;
                const headerActualHeight = DOM_ELEMENTS.mapHeader ? 
                    (DOM_ELEMENTS.mapHeader.offsetHeight || height * headerHeightPercentage) : 
                    height * headerHeightPercentage;

                const bottomBarActualHeight = DOM_ELEMENTS.bottomBarContainer && 
                    DOM_ELEMENTS.bottomBarContainer.style.display !== 'none' ? 
                    DOM_ELEMENTS.bottomBarContainer.offsetHeight : 0;

                const baseIconSize = this.isLandscape ? 
                    Math.min(width * 0.10, 200) : 
                    Math.min(width * 0.18, 100);

                // === üîß LIMPIAR textos previos para evitar duplicados ===
                if (DOM_ELEMENTS.mapModuleTextsContainer) {
                    DOM_ELEMENTS.mapModuleTextsContainer.innerHTML = '';
                }
                this.htmlModuleTextElements = [];

                // Definir posiciones para formar las letras C y S
                this.modulePositions = [];

                const centerX = width * 0.5;
                const centerY = height * 0.5;
                const radius = Math.min(width, height) * 0.25;

                this.modulePositions.push({ x: centerX - radius, y: centerY - radius });
                this.modulePositions.push({ x: centerX - radius * 1.5, y: centerY });
                this.modulePositions.push({ x: centerX - radius, y: centerY + radius });
                this.modulePositions.push({ x: centerX, y: centerY + radius });
                this.modulePositions.push({ x: centerX + radius, y: centerY + radius });
                this.modulePositions.push({ x: centerX + radius * 1.5, y: centerY });
                this.modulePositions.push({ x: centerX + radius, y: centerY - radius });
                this.modulePositions.push({ x: centerX, y: centerY - radius });

                this.currentNode = Math.max(0, Math.min(this.currentNode, GLOBAL_CONFIG.MODULE_COUNT - 1));

                this.moduleSprites = this.modulePositions.map((pos, i) => {
                    const isComplete = state.userSession.completedStages[i];
                    const iconKey = `module${i}`;

                    const icon = this.add.image(pos.x, pos.y, iconKey)
                        .setDepth(2)
                        .setDisplaySize(baseIconSize, baseIconSize)
                        .setInteractive({ useHandCursor: true })
                        .on('pointerdown', () => {
                            this.currentNode = i;
                            this.moveCharacterAndVisuals();
                        });

                    const textDiv = document.createElement('div');
                    textDiv.className = 'map-module-text';
                    DOM_ELEMENTS.mapModuleTextsContainer.appendChild(textDiv);
                    this.htmlModuleTextElements[i] = textDiv;

                    return {
                        icon: icon,
                        textDiv: textDiv,
                        originalScaleX: icon.scaleX,
                        originalScaleY: icon.scaleY
                    };
                });

                const baseCharacterSizeWidth = this.isLandscape ? 
                    Math.min(width * 0.35, 80) : 
                    Math.min(width * 0.08, 30);

                const baseCharacterSizeHeight = baseCharacterSizeWidth * 2;

                if (this.moduleSprites[this.currentNode]?.icon) {
                    const activeModuleIcon = this.moduleSprites[this.currentNode].icon;
                    this.character = this.add.image(
                        activeModuleIcon.x,
                        activeModuleIcon.y + activeModuleIcon.displayHeight * -0.6,
                        'character'
                    ).setDepth(3).setDisplaySize(baseCharacterSizeWidth, baseCharacterSizeHeight);
                }
            }

            drawConnections() {
                if (!this.connectionGraphics) return;
                this.connectionGraphics.clear();

                this.letterConnections.forEach(conn => {
                    const [startIndex, endIndex] = conn;
                    const startModule = state.userSession.completedStages[startIndex];
                    const endModule = state.userSession.completedStages[endIndex];
                    
                    if (startModule && endModule) {
                        const startIcon = this.moduleSprites[startIndex]?.icon;
                        const endIcon = this.moduleSprites[endIndex]?.icon;
                        
                        if (startIcon && endIcon) {
                            this.connectionGraphics.lineStyle(4, 0xFFD700, 0.7);
                            this.connectionGraphics.beginPath();
                            this.connectionGraphics.moveTo(startIcon.x, startIcon.y);
                            this.connectionGraphics.lineTo(endIcon.x, endIcon.y);
                            this.connectionGraphics.strokePath();
                        }
                    }
                });
            }

            updateModuleTextPositions() {
                if (
                    !this.cameras || !this.cameras.main ||
                    !DOM_ELEMENTS.mapModuleTextsContainer ||
                    !this.moduleSprites || this.moduleSprites.length === 0
                ) {
                    return;
                }

                // Inicializar htmlModuleTextElements si no existe o tiene longitud incorrecta
                if (!this.htmlModuleTextElements || this.htmlModuleTextElements.length !== this.moduleSprites.length) {
                    this.htmlModuleTextElements = [];

                    // Limpiar elementos previos
                    DOM_ELEMENTS.mapModuleTextsContainer.innerHTML = '';

                    // Crear uno por cada sprite
                    this.moduleSprites.forEach((_, i) => {
                        const div = document.createElement('div');
                        div.className = 'dream-label';
                        DOM_ELEMENTS.mapModuleTextsContainer.appendChild(div);
                        this.htmlModuleTextElements[i] = div;
                    });
                }

                this.moduleSprites.forEach((spriteGroup, i) => {
                    if (!spriteGroup.icon || !spriteGroup.icon.active || !this.htmlModuleTextElements[i]) {
                        return;
                    }

                    const icon = spriteGroup.icon;
                    const textDiv = this.htmlModuleTextElements[i];

                    try {
                        const pt = this.cameras.main.getWorldPoint(
                            icon.x,
                            icon.y + icon.displayHeight * 0.6 + (this.isLandscape ? 10 : 5)
                        );

                        textDiv.style.left = `${pt.x}px`;
                        textDiv.style.top = `${pt.y}px`;

                        let moduleLabel = `Sue√±o ${i + 1}`;
                        const isComplete = state.userSession.completedStages[i];

                        textDiv.classList.remove('completed', 'active');

                        if (isComplete) {
                            textDiv.classList.add('completed');
                            moduleLabel += " ‚úì";
                        }

                        if (i === this.currentNode) {
                            textDiv.classList.add('active');
                        }

                        textDiv.textContent = moduleLabel;
                    } catch (error) {
                        console.error("Error al actualizar posici√≥n del texto:", error);
                    }
                });
            }

            updateActiveModuleVisuals() {
                //this.activeModuleEffects.border.clear();
                this.activeModuleEffects.scanline.clear();
                
                if (this.activeModuleEffects.scanlineTween?.isPlaying()) {
                    this.activeModuleEffects.scanlineTween.stop();
                    this.activeModuleEffects.scanlineTween = null;
                }

                this.moduleSprites.forEach((spriteGroup, index) => {
                    if (spriteGroup.icon?.active) {
                        spriteGroup.icon.clearTint().setScale(spriteGroup.originalScaleX, spriteGroup.originalScaleY);
                        const icon = spriteGroup.icon;
                        const baseRect = {
                            x: icon.x - icon.displayWidth / 2,
                            y: icon.y - icon.displayHeight / 2,
                            width: icon.displayWidth,
                            height: icon.displayHeight
                        };
                        
                        if (index === this.currentNode) {
                            icon.setScale(spriteGroup.originalScaleX * 1.1, spriteGroup.originalScaleY * 1.1);
                            
                            const scanlineWidth = icon.displayWidth * 0.8;
                            const scanlineStartX = icon.x - scanlineWidth / 2;
                            let scanlineCurrentY = icon.y - icon.displayHeight / 2;
                            
                            this.activeModuleEffects.scanline.fillStyle(0xFFFFFF, 0.2)
                                .fillRect(scanlineStartX, scanlineCurrentY, scanlineWidth, 2);
                            
                            this.activeModuleEffects.scanlineTween = this.tweens.add({
                                targets: { y: scanlineCurrentY, alpha: 0.2 },
                                y: icon.y + icon.displayHeight / 2 - 2,
                                alpha: 0.05,
                                ease: 'Linear',
                                duration: 1500,
                                repeat: -1,
                                yoyo: true,
                                onUpdate: (tween, target) => {
                                    this.activeModuleEffects.scanline.clear();
                                    this.activeModuleEffects.scanline.fillStyle(0xFFFFFF, target.alpha);
                                    this.activeModuleEffects.scanline.fillRect(scanlineStartX, target.y, scanlineWidth, 2);
                                }
                            });
                        } else if (state.userSession.completedStages[index]) {
                            icon.setTint(0xDDDDDD);
                            
                        } 
                    }
                });
                
                this.updateModuleTextPositions();
            }

            update() {
                if (!this.cursors || !this.input.keyboard.enabled) return;
                
                let moved = false;
                
                if (Phaser.Input.Keyboard.JustDown(this.cursors.left)) {
                    if (this.currentNode > 0) { 
                        this.currentNode--; 
                        moved = true; 
                    }
                } else if (Phaser.Input.Keyboard.JustDown(this.cursors.right)) {
                    if (this.currentNode < GLOBAL_CONFIG.MODULE_COUNT - 1) { 
                        this.currentNode++; 
                        this.updateModuleTextPositions();
                        moved = true; 
                    }
                }
                
                if (moved) this.moveCharacterAndVisuals();
                
                if (Phaser.Input.Keyboard.JustDown(this.enterKey)) {
                    this.attemptEnterScene();
                }
            }

            moveCharacterAndVisuals(animate = true) {
                this.updateActiveModuleVisuals();
                this.updateModuleTextPositions();
                const activeModuleIcon = this.moduleSprites[this.currentNode]?.icon;
                
                if (activeModuleIcon && this.character?.active) {
                    const targetX = activeModuleIcon.x;
                    const targetY = activeModuleIcon.y + activeModuleIcon.displayHeight * -0.6;
                    
                    if (animate) {
                        this.tweens.timeline({
                            targets: this.character,
                            tweens: [
                                {
                                    x: targetX,
                                    y: targetY,
                                    ease: 'Sine.easeOut',
                                    duration: 1000,
                                    alpha: { from: 0.7, to: 1 },
                                    onStart: () => {
                                        this.character.setTint(0x66ffcc); // brillo al inicio
                                    }
                                },
                                {
                                    ease: 'Expo.easeOut',
                                    duration: 800,
                                    onComplete: () => {
                                        this.character.clearTint(); // quitar brillo
                                    }
                                }
                            ]
                        });
                    }
                    else {
                        this.character.x = targetX;
                        this.character.y = targetY;
                    }
                }
            }

            attemptEnterScene() {
                    if (!this.scene.isActive()) return;
                    const targetStageIndex = this.currentNode; 
                    this.scene.start('TriviaScene', { stageIndex: targetStageIndex });
                // if (!this.scene.isActive()) return;
                
                // const targetStageIndex = this.currentNode;
                // const isUnlocked = targetStageIndex === 0 || 
                //                 state.userSession.completedStages[targetStageIndex - 1];
                
                // if (isUnlocked) {
                //     this.scene.start('TriviaScene', { stageIndex: targetStageIndex });
                // } else {
                //     console.log(`Module ${targetStageIndex + 1} is locked.`);
                // }
            }

            shutdown() {
                this.scale.off('resize', this.handleResize, this);
                
                if (this.activeModuleEffects.scanlineTween?.isPlaying()) {
                    this.activeModuleEffects.scanlineTween.stop();
                }
                
                this.activeModuleEffects.scanlineTween = null;
                
                if (this.activeModuleEffects.border) this.activeModuleEffects.border.destroy();
                if (this.activeModuleEffects.scanline) this.activeModuleEffects.scanline.destroy();
                if (this.connectionGraphics) this.connectionGraphics.destroy();
                
                this.activeModuleEffects = { border: null, scanline: null, scanlineTween: null };
                this.connectionGraphics = null;
                
                if (this.character) this.character.destroy();
                this.character = null;
                
                this.moduleSprites.forEach(spriteGroup => { 
                    if (spriteGroup.icon) spriteGroup.icon.destroy(); 
                });
                
                this.moduleSprites = [];
                
                if (DOM_ELEMENTS.mapModuleTextsContainer) {
                    DOM_ELEMENTS.mapModuleTextsContainer.innerHTML = '';
                }
                
                this.htmlModuleTextElements = [];
                state.currentMapSceneRef = null;
            }
        }

        class TriviaScene extends Phaser.Scene {
            constructor() {
                super('TriviaScene');
                this.currentStageIndex = 0;
                this.selectedOptionIndex = -1;
                this.htmlOptionElements = [];
                this.currentTriviaData = null;
                this.moduleInfoUI = null;
                this.startTriviaButton = null;
            }

            init(data) {
                this.currentStageIndex = data.stageIndex;
                this.selectedOptionIndex = -1;
                this.htmlOptionElements = [];
            }

            // preload() {
            //     if (!this.textures.exists('background')) {
            //         this.load.image('background', `${GLOBAL_CONFIG.ASSETS_PATH}background.jpg`);
            //     }
            // }

            create() {
                this.currentTriviaData = GLOBAL_CONFIG.TRIVIA_QUESTIONS[this.currentStageIndex] || 
                                    GLOBAL_CONFIG.TRIVIA_QUESTIONS[0];
                
                this.moduleInfoUI = document.getElementById('moduleInfoUI');
                this.startTriviaButton = document.getElementById('startTriviaButton');
                
                this.showModuleInfo();
            }

            showModuleInfo() {
                manageUIContainersVisibility(['moduleInfoUI']);
                createStandardSceneBackground(this);

                const moduleInfoUI = document.getElementById('moduleInfoUI');
                const panelWrapper = moduleInfoUI.querySelector('.panel-content-wrapper');

                // Reiniciar estilo de animaci√≥n
                panelWrapper.style.opacity = 0;
                panelWrapper.style.animation = 'none';

                // Forzar reflow para reiniciar animaci√≥n
                void panelWrapper.offsetWidth;

                // Aplicar animaci√≥n existente
                panelWrapper.style.animation = 'fadeInHoloPanel 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards';

                // Actualizar textos del m√≥dulo
                document.getElementById('moduleInfoTitle').textContent = this.currentTriviaData.title;
                document.getElementById('moduleInfoDescription').textContent = this.currentTriviaData.description;

                const speakers = this.currentTriviaData.speakers || [];
                const speakersContainer = document.getElementById('moduleSpeakersContainer');
                const speakersList = document.getElementById('speakersList');

                if (speakers.length > 0) {
                    speakersList.innerHTML = '';
                    speakers.forEach(({ name, role, img }) => {
                        const card = document.createElement('div');
                        card.className = 'speaker-card';
                        card.innerHTML = `
                            <img src="${GLOBAL_CONFIG.ASSETS_PATH + img}" alt="${name}" class="speaker-photo">
                            <div class="speaker-name">${name}</div>
                            <div class="speaker-role">${role}</div>
                        `;
                        speakersList.appendChild(card);
                    });
                    speakersContainer.classList.remove('hidden');
                } else {
                    speakersContainer.classList.add('hidden');
                }

                const startButton = document.getElementById('startTriviaButton');
                if (startButton) {
                    startButton.onclick = () => {
                        startButton.style.transform = 'translateY(0) scale(1)';
                        this.showTrivia();
                    };
                    startButton.onmousedown = () => {
                        startButton.style.transform = 'translateY(1px) scale(0.99)';
                    };
                    startButton.onmouseup = () => {
                        startButton.style.transform = 'translateY(-2px) scale(1.02)';
                    };
                }
            }

            showTrivia() {
                manageUIContainersVisibility(['triviaUI']);
                
                if (!this.currentTriviaData || !DOM_ELEMENTS.triviaTitle || 
                    !DOM_ELEMENTS.triviaQuestion || !DOM_ELEMENTS.triviaOptionsContainer || 
                    !DOM_ELEMENTS.triviaConfirmButton || !DOM_ELEMENTS.triviaIncorrectMessage) {
                    console.error("Elementos de trivia faltantes.");
                    this.goBackToMap();
                    return;
                }
                
                DOM_ELEMENTS.triviaTitle.textContent = `Desaf√≠o de Ciberseguridad ${this.currentStageIndex + 1}`;
                DOM_ELEMENTS.triviaQuestion.textContent = this.currentTriviaData.question;
                DOM_ELEMENTS.triviaOptionsContainer.innerHTML = '';
                this.htmlOptionElements = [];
                
                this.currentTriviaData.options.forEach((optionText, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'trivia-option';
                    optionDiv.textContent = optionText;
                    optionDiv.onclick = () => this.selectOption(index);
                    DOM_ELEMENTS.triviaOptionsContainer.appendChild(optionDiv);
                    this.htmlOptionElements.push(optionDiv);
                });
                
                DOM_ELEMENTS.triviaConfirmButton.onclick = () => this.validateAnswer();
                DOM_ELEMENTS.triviaConfirmButton.classList.add('hidden');
                DOM_ELEMENTS.triviaIncorrectMessage.classList.add('hidden');
                this.selectedOptionIndex = -1;
                state.triviaStartTimes[this.currentStageIndex] = Date.now();
            }

            selectOption(index) {
                this.selectedOptionIndex = index;
                
                this.htmlOptionElements.forEach((div, i) => {
                    div.classList.toggle('selected', i === index);
                });
                
                if (DOM_ELEMENTS.triviaConfirmButton) {
                    DOM_ELEMENTS.triviaConfirmButton.classList.remove('hidden');
                }
                
                if (DOM_ELEMENTS.triviaIncorrectMessage) {
                    DOM_ELEMENTS.triviaIncorrectMessage.classList.add('hidden');
                }
            }

            validateAnswer() {
                if (this.selectedOptionIndex === -1 || !this.currentTriviaData) return;
                
                const isCorrect = this.selectedOptionIndex === this.currentTriviaData.correctAnswerIndex;
                
                if (isCorrect) {
                    // Calcular tiempo de respuesta
                    const endTime = Date.now();
                    const startTime = state.triviaStartTimes[this.currentStageIndex];
                    state.triviaResponseTimes[this.currentStageIndex] = endTime - startTime;
                    state.userSession.completedStages[this.currentStageIndex] = true;
                    
                    const allStagesCompleted = state.userSession.completedStages.every(status => status === true);
                    
                    if (allStagesCompleted) {
                        this.scene.start('BadgeScene');
                    } else {
                        this.goBackToMap();
                    }
                } else {
                    if (DOM_ELEMENTS.triviaIncorrectMessage) {
                        DOM_ELEMENTS.triviaIncorrectMessage.textContent = 
                            'Respuesta incorrecta. ¬°Intenta de nuevo o repasa tus conocimientos!';
                        DOM_ELEMENTS.triviaIncorrectMessage.classList.remove('hidden');
                    }
                    
                    this.htmlOptionElements.forEach(div => div.classList.remove('selected'));
                    this.selectedOptionIndex = -1;
                    
                    if (DOM_ELEMENTS.triviaConfirmButton) {
                        DOM_ELEMENTS.triviaConfirmButton.classList.add('hidden');
                    }
                }
            }

            cleanupBeforeTransition() {
                if (this.startTriviaButton) {
                    this.startTriviaButton.onclick = null;
                }
                
                if (DOM_ELEMENTS.triviaConfirmButton) {
                    DOM_ELEMENTS.triviaConfirmButton.onclick = null;
                }
                
                this.htmlOptionElements.forEach(div => div.onclick = null);
            }

            goBackToMap() {
                this.cleanupBeforeTransition();
                this.scene.start('MapScene');
            }

            shutdown() {
                this.cleanupBeforeTransition();
                this.htmlOptionElements = [];
                this.moduleInfoUI = null;
                this.startTriviaButton = null;
            }
        }

        class BadgeScene extends Phaser.Scene {
            constructor() {
                super('BadgeScene');
            }

            create() {
                const finalLogoPanel = document.getElementById('finalLogo');
                finalLogoPanel.classList.remove('hidden');
                finalLogoPanel.style.display = 'flex';

                const insigniaImage = document.getElementById('insigniaImage');
                this.loadInsigniaImage(insigniaImage);
                // Calcular tiempo total
                state.totalTriviaTime = state.triviaResponseTimes.reduce((sum, time) => sum + time, 0);
                // Enviar resultados finales
                this.sendFinalResults();
            }

            sendFinalResults() {
                const email = state.userSession.email;
                const grupo = state.userSession.grupo;
                const totalTime = state.totalTriviaTime/1000;
                console.log('tiempo trivia:', totalTime);
                fetch(GLOBAL_CONFIG.GOOGLE_SHEETS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        correo: email,
                        grupo: grupo,
                        tiempo: totalTime,
                        tipo: 'final'
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).catch(error => {
                    console.error('Error al enviar resultados finales:', error);
                });
            }

            loadInsigniaImage(imgElement) {
                const imagePath = `${GLOBAL_CONFIG.ASSETS_PATH}insigniaBP.png?t=${Date.now()}`;
                
                const testImage = new Image();
                
                testImage.onload = () => {
                    imgElement.src = imagePath;
                    console.log('Insignia cargada correctamente:', imagePath);
                };

                testImage.onerror = () => {
                    console.error('Error al cargar insignia:', imagePath);
                    this.showAlternativeBadge(imgElement);
                };

                testImage.src = imagePath;
            }

            showAlternativeBadge(imgElement) {
                imgElement.style.display = 'none';
                
                const badgeContainer = document.createElement('div');
                badgeContainer.className = 'alternative-badge';
                
                badgeContainer.innerHTML = `
                    <div class="badge-shape">
                        <span class="badge-icon">üõ°Ô∏è</span>
                        <span class="badge-text">${state.userSession.email?.split('@')[0] || 'Agente'}</span>
                    </div>
                `;
                
                const panelText = document.querySelector('.panel-text');
                panelText.insertAdjacentElement('afterend', badgeContainer);
                
                console.log('Mostrando insignia alternativa');
            }
        }

        // ==================== EVENT HANDLERS ====================
        function handleMoveLeft() {
            if (state.currentMapSceneRef?.scene.isActive()) {
                if (state.currentMapSceneRef.currentNode > 0) {
                    state.currentMapSceneRef.currentNode--;
                    state.currentMapSceneRef.moveCharacterAndVisuals();
                }
            }
        }

        function handleMoveRight() {
            if (state.currentMapSceneRef?.scene.isActive()) {
                if (state.currentMapSceneRef.currentNode < GLOBAL_CONFIG.MODULE_COUNT - 1) {
                    state.currentMapSceneRef.currentNode++;
                    state.currentMapSceneRef.moveCharacterAndVisuals();
                }
            }
        }

        function handleEnterScene() {
            if (state.currentMapSceneRef?.scene.isActive()) {
                state.currentMapSceneRef.attemptEnterScene();
            }
        }

        // ==================== VALIDATION FUNCTIONS ====================
        function validatePassword(password) {
            const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&\-_#])[A-Za-z\d@$!%*?&\-_#]{8,}$/;
            return regex.test(password);
        }

        function validateEmail(email) {
            const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return regex.test(email);
        }

        // ==================== MAIN GAME FUNCTIONS ====================
        function logAccessToGoogleSheets(email, grupo, elapsedSeconds) {
            fetch(GLOBAL_CONFIG.GOOGLE_SHEETS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    correo: email,
                    grupo: grupo,
                    tiempo: elapsedSeconds,
                    tipo: 'login'
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).catch(error => {
                console.error('Error al enviar datos a Google Sheets:', error);
            });
        }

        function startGame() {
            const email = DOM_ELEMENTS.emailInput.value.trim();
            const grupo = DOM_ELEMENTS.grupoInput.value.trim();
            const password = DOM_ELEMENTS.passwordInput.value.trim();
            
            if (!grupo || isNaN(grupo)) {
                DOM_ELEMENTS.loginError.textContent = 'Debe ingresar un n√∫mero de grupo v√°lido.';
                DOM_ELEMENTS.loginError.style.display = 'block';
                return;
            }

            if (!email) {
                DOM_ELEMENTS.loginError.textContent = 'El email es obligatorio.';
                DOM_ELEMENTS.loginError.style.display = 'block';
                return;
            }

            if (!validateEmail(email)) {
                DOM_ELEMENTS.loginError.textContent = 'Ingrese un correo electr√≥nico v√°lido.';
                DOM_ELEMENTS.loginError.style.display = 'block';
                return;
            }

            state.loginAttempts++;

            if (state.loginAttempts >= 3) {
                logAccessToGoogleSheets(email, grupo, 10000);

                state.userSession = {
                    email: email,
                    grupo: grupo,
                    completedStages: Array(GLOBAL_CONFIG.MODULE_COUNT).fill(false)
                };

                DOM_ELEMENTS.loginError.style.display = 'none';
                initializePhaserGame();
                return;
            }

            if (!validatePassword(password)) {
                DOM_ELEMENTS.loginError.textContent = 
                    'La contrase√±a debe tener al menos 8 caracteres, incluyendo may√∫sculas, min√∫sculas, n√∫meros y un s√≠mbolo.';
                DOM_ELEMENTS.loginError.style.display = 'block';
                return;
            }

            state.userSession = {
                email: email,
                grupo: grupo,
                completedStages: Array(GLOBAL_CONFIG.MODULE_COUNT).fill(false)
            };

            // Reiniciar tiempos al iniciar sesi√≥n
            state.triviaStartTimes = Array(GLOBAL_CONFIG.MODULE_COUNT).fill(0);
            state.triviaResponseTimes = Array(GLOBAL_CONFIG.MODULE_COUNT).fill(0);
            state.totalTriviaTime = 0;

            DOM_ELEMENTS.loginError.style.display = 'none';

            const elapsedSeconds = Math.floor((Date.now() - state.startTime) / 1000);
            logAccessToGoogleSheets(email, grupo, elapsedSeconds);

            state.userSession.email = email;
            state.userSession.grupo = grupo;
            state.userSession.completedStages.fill(false);

            initializePhaserGame();
        }

        function initializePhaserGame() {
            manageUIContainersVisibility([]);

            const phaserConfig = {
                type: Phaser.AUTO,
                width: window.innerWidth,
                height: window.innerHeight,
                resolution: window.devicePixelRatio || 1,
                parent: 'phaser-game',
                transparent: true,
                scale: {
                    mode: Phaser.Scale.RESIZE,
                    autoCenter: Phaser.Scale.CENTER_BOTH
                },
                scene: [MapScene, TriviaScene, BadgeScene],
                render: { antialias: true, pixelArt: false },
                input: {
                    keyboard: {
                        capture: [
                            Phaser.Input.Keyboard.KeyCodes.LEFT,
                            Phaser.Input.Keyboard.KeyCodes.RIGHT,
                            Phaser.Input.Keyboard.KeyCodes.ENTER,
                            Phaser.Input.Keyboard.KeyCodes.SPACE
                        ]
                    }
                }
            };

            if (state.gameInstance) {
                state.gameInstance.scene.getScenes(true).forEach(scene => {
                    if (scene.sys.isActive() && typeof scene.shutdown === 'function') {
                        scene.shutdown();
                    }
                    if (scene.sys.isActive()) {
                        state.gameInstance.scene.stop(scene.scene.key);
                    }
                });
                state.gameInstance.destroy(true);
                state.gameInstance = null;
            }

            state.gameInstance = new Phaser.Game(phaserConfig);
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Oculta el login al inicio
            DOM_ELEMENTS.loginUI.style.display = 'none';

            // Mostrar solar intro y ocultar luego
            setTimeout(() => {
            const solar = document.getElementById('solarIntro');
            const login = DOM_ELEMENTS.loginUI;

            if (solar && login) {
                solar.style.opacity = '0';
                login.style.display = 'flex';

                setTimeout(() => {
                    solar.style.display = 'none';
                    login.style.opacity = '1';
                }, 1200); // Tiempo de la animaci√≥n
            }
            }, 6000);

            manageUIContainersVisibility(['loginUI']);
                
            if (DOM_ELEMENTS.loginButton) {
                DOM_ELEMENTS.loginButton.onclick = startGame;
            }
            
            if (DOM_ELEMENTS.moveLeftButton) {
                DOM_ELEMENTS.moveLeftButton.onclick = handleMoveLeft;
            }
            
            if (DOM_ELEMENTS.enterSceneButton) {
                DOM_ELEMENTS.enterSceneButton.onclick = handleEnterScene;
            }
            
            if (DOM_ELEMENTS.moveRightButton) {
                DOM_ELEMENTS.moveRightButton.onclick = handleMoveRight;
            }
        });
    </script>
</body>
</html>