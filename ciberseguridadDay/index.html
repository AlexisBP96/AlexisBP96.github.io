<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ciberseguridad Day</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            color: #fff; 
        }
        #phaser-game { /* Contenedor para el canvas de Phaser y la UI HTML superpuesta */
            position: relative; /* Permite posicionar elementos HTML absolutamente dentro */
            width: 100%;
            height: 100%;
        }
        #phaser-game canvas { 
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0; 
        }

        #loginUI, #finalLogo {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; 
            text-align: center;
            gap: 10px; 
            box-sizing: border-box;
            padding: 15px;
        }

        #loginUI {
            background: linear-gradient(to bottom, #000000cc, #000000ee),
            url('assets/background.jpg') no-repeat center center/cover;
        }

        #loginUI img {
            width: 100px;
            max-width: 25%;
            height: auto;
            margin-bottom: 5px;
        }

        #loginUI h1 {
            color: #FFD700;
            font-size: clamp(18px, 4.5vw, 28px);
            margin: 0;
        }

        #loginUI p {
            color: #ffffff;
            font-size: clamp(13px, 3.2vw, 16px);
            max-width: 90%;
        }

        #loginUI input, #loginUI button {
            padding: 10px 18px;
            font-size: clamp(13px, 3.2vw, 16px);
            border-radius: 8px;
            border: none;
        }

        #loginUI input {
            width: 80%;
            max-width: 280px;
        }

        #loginUI button {
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        #loginUI button:hover {
            background-color: #e6c200;
        }

        #finalLogo {
            display: none; 
        }

        #finalLogo h2 {
            font-size: clamp(18px, 5vw, 28px); 
            color: #FFD700;
            margin-bottom: 3px; 
        }

        #finalLogo p {
            font-size: clamp(14px, 3.5vw, 18px); 
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 10px; 
        }
        
        #insigniaCanvas {
            display: block; 
            margin: 0 auto; 
            max-width: 80vw;   
            max-height: 60vh;  
            width: auto; 
            height: auto; 
            object-fit: contain; 
        }

        /* --- Estilos para UI HTML de MapScene (Header y Textos de Módulos) --- */
        #mapHeader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px; 
            box-sizing: border-box;
            text-align: center;
            z-index: 10; 
            background-color: rgba(0,0,0,0.8); 
            border-bottom: 1px solid rgba(0, 221, 0, 0.7); 
            display: none; 
        }
        #mapTitle {
            color: #FFD700;
            font-size: clamp(12px, 2vw, 18px); 
            font-weight: bold;
            margin: 0 0 3px 0;
            text-shadow: 0.5px 0.5px 1px #000;
        }
        #mapDescription {
            color: #E0E0E0;
            font-size: clamp(9px, 1.6vw, 13px); 
            margin: 0;
            text-shadow: 0.5px 0.5px 1px #000;
        }

        #mapModuleTextsContainer { /* Contenedor para los textos HTML de los módulos */
            position: absolute;
            top: 0; /* Se ajustará con JS si es necesario, pero los divs internos son absolutos */
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Para que no interfiera con el input de Phaser en los iconos */
            z-index: 5; /* Detrás del personaje, pero encima del fondo */
            display: none; /* Controlado por JS */
        }

        .map-module-text {
            position: absolute; /* Posicionamiento se hará con JS */
            transform: translateX(-50%); /* Para centrar el texto debajo del icono */
            color: #E0E0E0;
            font-size: clamp(8px, 1.5vw, 11px);
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            padding: 2px 4px;
            /* background-color: rgba(0,0,0,0.3); Opcional para legibilidad */
            /* border-radius: 3px; */
            text-shadow: 0.5px 0.5px 1px #000;
        }
        .map-module-text.completed {
            color: #77FF77;
        }
        .map-module-text.active {
            color: #FFD700;
            font-weight: bold;
        }


        /* --- Estilos para UI HTML de TriviaScene --- */
        #triviaUI {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20; 
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            gap: 15px; 
        }
        #triviaTitle {
            font-size: clamp(18px, 5.5vw, 28px);
            color: #FFD700;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }
        #triviaQuestion {
            font-size: clamp(15px, 4vw, 22px);
            color: #ffffff;
            max-width: 90%;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px #000;
        }
        #triviaOptionsContainer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 85%;
            max-width: 400px;
        }
        .trivia-option {
            font-size: clamp(13px, 3.5vw, 18px);
            color: #ffffff;
            background-color: rgba(51, 51, 51, 0.8); 
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid rgba(100,100,100,0.5);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            box-shadow: 0px 2px 4px rgba(0,0,0,0.2);
        }
        .trivia-option:hover {
            background-color: rgba(65, 65, 65, 0.9);
            border-color: rgba(150,150,150,0.7);
        }
        .trivia-option.selected {
            background-color: #FFD700;
            color: #000000;
            font-weight: bold;
            border-color: #FFD700;
        }
        #triviaConfirmButton {
            font-size: clamp(15px, 4.5vw, 20px);
            color: #000000;
            background-color: #FFD700;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.2s;
            display: none; 
        }
        #triviaConfirmButton:hover {
            background-color: #e6c200;
        }
        #triviaIncorrectMessage {
            font-size: clamp(13px, 3.8vw, 17px);
            color: #ff4d4d;
            background-color: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 10px;
            display: none; 
        }


        #bottomBarContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #000000; 
            z-index: 25; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
        }

        .touch-controls {
            width: 100%; 
            box-sizing: border-box;
            padding: 8px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            border-top: 2px solid #00FF00; 
        }

        .touch-controls button {
            padding: 10px 16px;
            font-size: clamp(18px, 4.5vw, 22px);
            border-radius: 8px;
            border: none;
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            min-width: 55px;
            text-align: center;
            box-shadow: 0px 1px 3px rgba(0,0,0,0.2);
        }
        .touch-controls button:active {
            background-color: #e6c200;
        }

        .logo-footer {
            width: 60px;
            max-width: 15%;
            height: auto;
            margin-top: 5px; 
            margin-bottom: 5px; 
        }


        @media (max-width: 600px) {
            #loginUI h1 { font-size: clamp(18px, 5.5vw, 26px); }
            #loginUI p { font-size: clamp(12px, 3.5vw, 15px); }
            #loginUI input, #loginUI button {
                font-size: clamp(12px, 3.5vw, 15px);
                padding: 8px 12px;
            }
            #finalLogo h2 { font-size: clamp(16px, 6vw, 24px); }
            #finalLogo p { font-size: clamp(13px, 3.8vw, 16px); }
            #insigniaCanvas { max-width: 75vw; max-height: 55vh; }

            #mapTitle { font-size: clamp(13px, 3.2vw, 20px); }
            #mapDescription { font-size: clamp(10px, 2.5vw, 14px); }
            .map-module-text { font-size: clamp(9px, 2.2vw, 12px); }
            
            #triviaTitle { font-size: clamp(16px, 5vw, 24px); }
            #triviaQuestion { font-size: clamp(14px, 3.8vw, 20px); }
            .trivia-option { font-size: clamp(12px, 3.2vw, 16px); padding: 10px 12px;}
            #triviaConfirmButton { font-size: clamp(14px, 4vw, 18px); padding: 10px 20px;}


            .touch-controls { padding: 6px 0; gap: 10px; }
            .touch-controls button { font-size: clamp(16px, 4vw, 20px); padding: 8px 12px; min-width: 50px; }
            .logo-footer { width: 50px; margin-top: 3px; margin-bottom: 3px; }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #loginUI h1, #loginUI p, #loginUI input, #loginUI button,
            #finalLogo h2, #finalLogo p { font-size: clamp(11px, 2.2vw, 14px); }
            #loginUI p { font-size: clamp(10px, 2vw, 12px); }
            #insigniaCanvas { max-width: 50vw; max-height: 70vh; }

            #mapTitle { font-size: clamp(12px, 2vw, 18px); }
            #mapDescription { font-size: clamp(9px, 1.6vw, 13px); }
            .map-module-text { font-size: clamp(8px, 1.5vw, 11px); }

            #triviaUI { gap: 10px; padding: 15px;}
            #triviaTitle { font-size: clamp(16px, 4.5vw, 22px); }
            #triviaQuestion { font-size: clamp(13px, 3.2vw, 18px); margin-bottom: 5px;}
            .trivia-option { font-size: clamp(11px, 2.8vw, 15px); padding: 8px 10px;}
            #triviaConfirmButton { font-size: clamp(13px, 3.5vw, 17px); padding: 8px 18px;}


            .touch-controls { padding: 5px 0; }
            .touch-controls button { font-size: clamp(14px, 3.5vw, 16px); padding: 6px 10px; }
            #loginUI img { margin-bottom: 3px; max-width: 18%; }
            #loginUI, #finalLogo { gap: 8px; }
            .logo-footer { width: 45px; margin-top: 2px; margin-bottom: 2px;}
        }
    </style>
</head>
<body>
<div id="phaser-game">
    </div>

<div id="loginUI">
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha">
    <h1>¡Bienvenido a la Feria de Ciberseguridad! 5</h1>
    <p>Demuestra tu conocimiento Ciberguardián en protección digital. Supera los retos, responde las trivias y conquista la galaxia de la ciberseguridad.</p>
    <input type="text" id="usernameInput" placeholder="Ingresa tu nombre">
    <button onclick="startGame()">Comenzar misión</button>
</div>

<div id="mapHeader">
    <div id="mapTitle"></div>
    <div id="mapDescription"></div>
</div>
<div id="mapModuleTextsContainer">
    </div>


<div id="triviaUI">
    <div id="triviaTitle"></div>
    <div id="triviaQuestion"></div>
    <div id="triviaOptionsContainer">
        </div>
    <button id="triviaConfirmButton">Responder</button>
    <div id="triviaIncorrectMessage"></div>
</div>


<div id="finalLogo">
    <div style="text-align: center; color: white;">
        <h2 style="color: #FFD700;">¡MISIÓN CUMPLIDA!</h2>
        <p style="color: #ffffff;">Has superado todos los desafíos y obtuviste tu insignia Ciberguardián ⭐</p>
    </div>
    <canvas id="insigniaCanvas"></canvas> 
</div>

<div id="bottomBarContainer">
    <div class="touch-controls" id="touchControls">
        <button onclick="moveLeft()">⬅️</button>
        <button onclick="enterScene()">🚀</button>
        <button onclick="moveRight()">➡️</button>
    </div>
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha" class="logo-footer" id="logoFooter">
</div>


<script>
let userSession = {
    username: '',
    completedStages: [false, false, false] 
};

let gameInstance = null;
let currentMapScene = null;

const GLOBAL_FONT_FAMILY_HTML = 'Segoe UI, Arial, sans-serif'; 
const MODULE_COUNT = 3; 

// Elementos HTML de la UI del Mapa
let mapHeaderDiv, mapTitleDiv, mapDescriptionDiv, mapModuleTextsContainerDiv;
// Elementos HTML de la UI de Trivia
let triviaUIDiv, triviaTitleDiv, triviaQuestionDiv, triviaOptionsContainerDiv, triviaConfirmButton, triviaIncorrectMessageDiv;


function createSceneBackground(scene) {
    scene.bg = scene.add.image(scene.scale.width / 2, scene.scale.height / 2, 'background')
        .setDisplaySize(scene.scale.width, scene.scale.height)
        .setDepth(-1); 

    scene.overlay = scene.add.rectangle(0, 0, scene.scale.width, scene.scale.height, 0x000000, 0.75)
        .setOrigin(0)
        .setDepth(-0.5); 
}

function resizeSceneBackground(scene) {
    if (scene.bg) {
        scene.bg.setPosition(scene.scale.width / 2, scene.scale.height / 2)
                 .setDisplaySize(scene.scale.width, scene.scale.height);
    }
    if (scene.overlay) {
        scene.overlay.setSize(scene.scale.width, scene.scale.height);
    }
}

class MapScene extends Phaser.Scene {
    constructor() { 
        super('MapScene');
        this.moduleSprites = []; 
        this.htmlModuleTextElements = []; // Para los divs de texto HTML
    }

    preload() {
        this.load.image('background', 'assets/background.jpg');
        this.load.image('module', 'assets/module.png'); 
        this.load.image('module-complete', 'assets/module-green.png'); 
        this.load.image('character', 'assets/Jedi.png'); 
    }

    create() {
        currentMapScene = this;
        this.hideAllHtmlUI(); 
        
        mapHeaderDiv = document.getElementById('mapHeader');
        mapTitleDiv = document.getElementById('mapTitle');
        mapDescriptionDiv = document.getElementById('mapDescription');
        mapModuleTextsContainerDiv = document.getElementById('mapModuleTextsContainer');
        
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'flex'; 
        if (mapHeaderDiv) mapHeaderDiv.style.display = 'block';
        if (mapModuleTextsContainerDiv) mapModuleTextsContainerDiv.style.display = 'block';


        createSceneBackground(this); 

        this.drawSceneElements(); 
        this.cursors = this.input.keyboard.createCursorKeys();
        this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

        this.scale.on('resize', this.handleResize, this);
        this.updateModuleTextPositions(); // Posicionar textos HTML
        this.updateActiveModuleVisuals(); 
    }

    hideAllHtmlUI() {
        const elementsToHide = ['mapHeader', 'mapModuleTextsContainer', 'triviaUI', 'finalLogo'];
        elementsToHide.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
    }

    handleResize() {
        resizeSceneBackground(this);
        this.moduleSprites.forEach(spriteGroup => { 
            if(spriteGroup.icon) spriteGroup.icon.destroy();
            // No necesitamos destruir el texto de Phaser si ya no lo usamos
        });
        this.moduleSprites = [];
        this.htmlModuleTextElements.forEach(textDiv => textDiv.remove());
        this.htmlModuleTextElements = [];

        if (this.character) this.character.destroy();
        
        this.drawSceneElements(); 
        this.updateModuleTextPositions();
        this.updateActiveModuleVisuals(); 
    }

    drawSceneElements() { 
        const width = this.scale.width;
        const height = this.scale.height;
        this.isLandscape = width > height;

        mapTitleDiv.textContent = `Hola ${userSession.username.split(' ')[0]}, Ciberguardián`;
        mapDescriptionDiv.textContent = `Supera las misiones y demuestra tu destreza.`;
        
        const headerHeightPercentage = this.isLandscape ? 0.14 : 0.11; 
        mapHeaderDiv.style.paddingTop = `${height * headerHeightPercentage * 0.15}px`;
        mapHeaderDiv.style.paddingBottom = `${height * headerHeightPercentage * 0.15}px`;
        
        const baseIconSize = this.isLandscape ? Math.min(width * 0.055, 42) : Math.min(width * 0.1, 48); // Ligeramente más pequeños
        
        this.modulePositions = []; 
        const headerActualHeight = mapHeaderDiv.offsetHeight || height * headerHeightPercentage;

        if (this.isLandscape) {
            const moduleAreaY = headerActualHeight + (height - headerActualHeight) * 0.65; 
            const totalModuleWidth = width * 0.45; // Más compactos
            const moduleSpacingX = totalModuleWidth / (MODULE_COUNT > 1 ? MODULE_COUNT -1 : 1); 
            let currentX = (width - (moduleSpacingX * (MODULE_COUNT - 1))) / 2;
            for (let i = 0; i < MODULE_COUNT; i++) {
                this.modulePositions.push({ x: currentX, y: moduleAreaY });
                currentX += moduleSpacingX;
            }
        } else { 
            const moduleAreaX = width / 2;
            const moduleGroupHeight = (height - headerActualHeight) * 0.45; 
            const startY = headerActualHeight + (height - headerActualHeight) * 0.3;
            const moduleSpacingY = moduleGroupHeight / (MODULE_COUNT > 1 ? MODULE_COUNT -1 : 1) * 0.85;
            for (let i = 0; i < MODULE_COUNT; i++) {
                this.modulePositions.push({ x: moduleAreaX, y: startY + (i * moduleSpacingY) });
            }
        }
        
        this.currentNode = this.currentNode !== undefined ? this.currentNode : 0;

        mapModuleTextsContainerDiv.innerHTML = ''; // Limpiar textos HTML anteriores
        this.htmlModuleTextElements = [];

        this.moduleSprites = this.modulePositions.map((pos, i) => {
            const isComplete = userSession.completedStages?.[i];
            const iconKey = isComplete ? 'module-complete' : 'module';
            
            const icon = this.add.image(pos.x, pos.y, iconKey).setDepth(1)
                .setDisplaySize(baseIconSize, baseIconSize).setInteractive({ useHandCursor: true })
                .on('pointerdown', () => { this.currentNode = i; this.moveCharacter(); });
            
            // Crear el div HTML para el texto del módulo
            const textDiv = document.createElement('div');
            textDiv.className = 'map-module-text';
            mapModuleTextsContainerDiv.appendChild(textDiv);
            this.htmlModuleTextElements.push(textDiv);
            
            return { icon: icon, textDiv: textDiv, originalScale: icon.scaleX };
        });
        
        const baseCharacterSizeWidth = this.isLandscape ? Math.min(width * 0.045, 38) : Math.min(width * 0.08, 45);
        const baseCharacterSizeHeight = baseCharacterSizeWidth * 1.3;

        if (this.moduleSprites[this.currentNode]?.icon) {
            const activeModuleIcon = this.moduleSprites[this.currentNode].icon;
            this.character = this.add.image(activeModuleIcon.x, 
                activeModuleIcon.y - activeModuleIcon.displayHeight / 2 - baseCharacterSizeHeight * 0.4, 
                'character').setDepth(2).setDisplaySize(baseCharacterSizeWidth, baseCharacterSizeHeight);
        }
    }

    updateModuleTextPositions() {
        if (!mapModuleTextsContainerDiv) return;
        const gameCanvas = this.game.canvas;

        this.moduleSprites.forEach((spriteGroup, i) => {
            if (spriteGroup.icon && spriteGroup.icon.active && spriteGroup.textDiv) {
                const icon = spriteGroup.icon;
                const textDiv = spriteGroup.textDiv;
                
                // Convertir coordenadas del mundo de Phaser a coordenadas del viewport
                const pt = this.cameras.main.getWorldPoint(icon.x, icon.y + icon.displayHeight * 0.5 + 5); // 5px de offset hacia abajo
                
                textDiv.style.left = `${pt.x}px`;
                textDiv.style.top = `${pt.y}px`;

                let moduleLabel = `Fase ${i + 1}`;
                const isComplete = userSession.completedStages?.[i];
                textDiv.classList.remove('completed', 'active');

                if (isComplete) {
                    textDiv.classList.add('completed');
                    moduleLabel += " ⭐";
                }
                if (i === this.currentNode) {
                    textDiv.classList.add('active');
                }
                textDiv.textContent = moduleLabel;
            }
        });
    }
    
    updateActiveModuleVisuals() {
        this.moduleSprites.forEach((spriteGroup, index) => {
            if (spriteGroup.icon && spriteGroup.icon.active) {
                spriteGroup.icon.clearTint().setScale(spriteGroup.originalScale);
                if (index === this.currentNode) {
                    this.activeModuleSpriteIcon = spriteGroup.icon;
                    this.activeModuleSpriteIcon.setTint(0xFFFF99).setScale(spriteGroup.originalScale * 1.05);
                }
            }
        });
        this.updateModuleTextPositions(); // Asegurar que los textos HTML también se actualicen
    }

    update() {
        if (!this.cursors) return;
        let moved = false;
        if (Phaser.Input.Keyboard.JustDown(this.cursors.right) && this.currentNode < (MODULE_COUNT - 1)) {
            this.currentNode++; moved = true;
        } else if (Phaser.Input.Keyboard.JustDown(this.cursors.left) && this.currentNode > 0) {
            this.currentNode--; moved = true;
        }
        if(moved) this.moveCharacter();
        if (Phaser.Input.Keyboard.JustDown(this.enterKey)) enterScene();
    }

    moveCharacter(animate = true) {
        this.updateActiveModuleVisuals(); 
        const activeModuleIcon = this.moduleSprites?.[this.currentNode]?.icon;
        if (activeModuleIcon && this.character && this.character.active) {
            const targetX = activeModuleIcon.x;
            const targetY = activeModuleIcon.y - activeModuleIcon.displayHeight * activeModuleIcon.scaleY / 2 - this.character.displayHeight * 0.4; 
            if (animate) {
                this.tweens.add({ targets: this.character, x: targetX, y: targetY, ease: 'Sine.easeInOut', duration: 250 });
            } else {
                this.character.x = targetX; this.character.y = targetY;
            }
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
        if (mapHeaderDiv) mapHeaderDiv.style.display = 'none';
        if (mapModuleTextsContainerDiv) mapModuleTextsContainerDiv.style.display = 'none';
    }
}

class TriviaScene extends Phaser.Scene { // Mantenemos UI HTML para Trivia
    constructor() { super('TriviaScene'); }
    init(data) {
        this.stage = data.stage; this.selectedOptionIndex = -1; 
        this.htmlOptionElements = [];
    }
    preload() {
        if (!this.textures.exists('background')) this.load.image('background', 'assets/background.jpg');
    }
    create() {
        this.hideAllHtmlUI();
        triviaUIDiv = document.getElementById('triviaUI');
        triviaTitleDiv = document.getElementById('triviaTitle');
        triviaQuestionDiv = document.getElementById('triviaQuestion');
        triviaOptionsContainerDiv = document.getElementById('triviaOptionsContainer');
        triviaConfirmButton = document.getElementById('triviaConfirmButton');
        triviaIncorrectMessageDiv = document.getElementById('triviaIncorrectMessage');

        if(triviaUIDiv) triviaUIDiv.style.display = 'flex';
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'none'; 
        
        createSceneBackground(this); 
        this.drawTriviaUI(); 
    }
    hideAllHtmlUI() {
        const elementsToHide = ['mapHeader', 'mapModuleTextsContainer', 'triviaUI', 'finalLogo'];
        elementsToHide.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
    }
    drawTriviaUI() {
        triviaTitleDiv.textContent = `Trivia Fase ${this.stage}`;
        triviaQuestionDiv.textContent = '¿Qué es phishing?'; 
        const opciones = ['Una técnica para pescar', 'Un intento de engañar a usuarios para robar datos', 'Un software antivirus'];
        triviaOptionsContainerDiv.innerHTML = ''; 
        this.htmlOptionElements = [];
        opciones.forEach((opcionTexto, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'trivia-option';
            optionDiv.textContent = opcionTexto;
            optionDiv.onclick = () => this.seleccionarOpcion(index);
            triviaOptionsContainerDiv.appendChild(optionDiv);
            this.htmlOptionElements.push(optionDiv);
        });
        triviaConfirmButton.onclick = () => this.validarRespuesta();
        triviaConfirmButton.style.display = 'none'; 
        triviaIncorrectMessageDiv.style.display = 'none'; 
        this.selectedOptionIndex = -1; 
    }
    seleccionarOpcion(index) {
        this.selectedOptionIndex = index;
        this.htmlOptionElements.forEach((div, i) => div.classList.toggle('selected', i === index));
        triviaConfirmButton.style.display = 'block';
        triviaIncorrectMessageDiv.style.display = 'none';
    }
    validarRespuesta() {
        if (this.selectedOptionIndex === -1) return;
        const opcionSeleccionadaTexto = this.htmlOptionElements[this.selectedOptionIndex].textContent;
        if (opcionSeleccionadaTexto.includes('engañar a usuarios para robar datos')) { 
            userSession.completedStages[this.stage - 1] = true; 
            const todasCompletadas = userSession.completedStages.every(e => e === true);
            this.scene.start(todasCompletadas ? 'BadgeScene' : 'MapScene');
        } else {
            triviaIncorrectMessageDiv.textContent = '❌ Respuesta incorrecta. Intenta otra vez.';
            triviaIncorrectMessageDiv.style.display = 'block';
            this.htmlOptionElements.forEach(div => div.classList.remove('selected'));
            this.selectedOptionIndex = -1;
            triviaConfirmButton.style.display = 'none';
        }
    }
    shutdown() {
        if(triviaUIDiv) triviaUIDiv.style.display = 'none';
    }
}

class BadgeScene extends Phaser.Scene { 
    constructor() { super('BadgeScene'); }
    preload() {
        if (!this.textures.exists('background')) this.load.image('background', 'assets/background.jpg');
        this.load.image('insigniaBP', 'assets/insigniaBP.png');
    }
    create() {
        this.hideAllHtmlUI();
        document.getElementById('finalLogo').style.display = 'flex';
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'none'; 
        createSceneBackground(this);
        this.drawDynamicInsignia(userSession.username);
    }
    hideAllHtmlUI() {
        const elementsToHide = ['mapHeader', 'mapModuleTextsContainer', 'triviaUI'];
        elementsToHide.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
    }
    drawDynamicInsignia(nombre) {
        const canvas = document.getElementById('insigniaCanvas'); if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const imgTexture = this.textures.get('insigniaBP');
        if (!imgTexture || imgTexture.key === '__MISSING') {
            console.error("Textura insignia no cargada."); canvas.width = 200; canvas.height = 50;
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle="red"; ctx.font=`14px ${GLOBAL_FONT_FAMILY_HTML}`;
            ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("Error Insignia",canvas.width/2,canvas.height/2); return;
        }
        const img = imgTexture.getSourceImage(); 
        canvas.width = img.naturalWidth || img.width; canvas.height = img.naturalHeight || img.height;
        ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height);
        const fontSize = Math.max(8, canvas.width * 0.05); 
        ctx.font = `bold ${fontSize}px ${GLOBAL_FONT_FAMILY_HTML}`; ctx.fillStyle = '#000000'; 
        ctx.textAlign = 'center'; ctx.fillText(nombre.toUpperCase(), canvas.width/2, canvas.height * 0.735); 
    }
    shutdown() {}
}

function moveLeft() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode > 0) {
        currentMapScene.currentNode--; currentMapScene.moveCharacter();
    }
}
function moveRight() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode < (MODULE_COUNT - 1)) {
        currentMapScene.currentNode++; currentMapScene.moveCharacter();
    }
}
function enterScene() {
    if (currentMapScene && currentMapScene.sys.isActive()) {
        const index = currentMapScene.currentNode;
        const unlocked = index === 0 || userSession?.completedStages?.[index - 1];
        if (unlocked && currentMapScene.scene.key === 'MapScene') {
            currentMapScene.scene.start('TriviaScene', { stage: index + 1 });
        }
    }
}

function startGame() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    if (username === '') {
        usernameInput.style.border = "2px solid red";
        let errorMsg = document.getElementById('usernameError');
        if (!errorMsg) {
            errorMsg = document.createElement('p'); errorMsg.id = 'usernameError';
            errorMsg.textContent = '¡El nombre no puede estar vacío!'; errorMsg.style.color = 'red';
            errorMsg.style.fontSize = 'clamp(12px, 3vw, 14px)';
            usernameInput.parentNode.insertBefore(errorMsg, usernameInput.nextSibling);
        } return;
    }
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();
    usernameInput.style.border = "none";
    userSession.username = username;
    userSession.completedStages = Array(MODULE_COUNT).fill(false); 
    document.getElementById('loginUI').style.display = 'none';

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        resolution: window.devicePixelRatio || 1, 
        parent: 'phaser-game', 
        transparent: true, 
        scale: {
            mode: Phaser.Scale.RESIZE,
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        scene: [MapScene, TriviaScene, BadgeScene],
        render: { antialias: true, pixelArt: false },
        pipeline: { PostFX: true }
    };

    if (gameInstance) {
        gameInstance.scene.getScenes(true).forEach(scene => {
            if (scene.sys.isActive() && scene.shutdown) scene.shutdown();
        });
        gameInstance.destroy(true); gameInstance = null;
    }
    gameInstance = new Phaser.Game(config);
}

window.addEventListener('resize', () => { 
    if (gameInstance && gameInstance.scene.isActive('MapScene')) {
        // Forzar una actualización de las posiciones del texto HTML si la escena del mapa está activa
        // Esto es un poco un hack, idealmente el listener de resize de la escena se encargaría
        const mapScene = gameInstance.scene.getScene('MapScene');
        if (mapScene && typeof mapScene.updateModuleTextPositions === 'function') {
            // Pequeño delay para asegurar que el reescalado de Phaser haya terminado
            setTimeout(() => mapScene.updateModuleTextPositions(), 50);
        }
    }
});
document.addEventListener('DOMContentLoaded', () => {
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();
    
    mapHeaderDiv = document.getElementById('mapHeader');
    mapTitleDiv = document.getElementById('mapTitle');
    mapDescriptionDiv = document.getElementById('mapDescription');
    mapModuleTextsContainerDiv = document.getElementById('mapModuleTextsContainer');
    
    triviaUIDiv = document.getElementById('triviaUI');
    triviaTitleDiv = document.getElementById('triviaTitle');
    triviaQuestionDiv = document.getElementById('triviaQuestion');
    triviaOptionsContainerDiv = document.getElementById('triviaOptionsContainer');
    triviaConfirmButton = document.getElementById('triviaConfirmButton');
    triviaIncorrectMessageDiv = document.getElementById('triviaIncorrectMessage');

    const bottomBar = document.getElementById('bottomBarContainer');
    
    if (document.getElementById('loginUI').style.display !== 'none') {
        if (bottomBar) bottomBar.style.display = 'none';
        if (mapHeaderDiv) mapHeaderDiv.style.display = 'none';
        if (mapModuleTextsContainerDiv) mapModuleTextsContainerDiv.style.display = 'none';
        if (triviaUIDiv) triviaUIDiv.style.display = 'none';
    }
});

</script>

</body>
</html>
