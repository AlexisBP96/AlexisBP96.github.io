<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ciberseguridad Day</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            color: #fff; 
        }
        #phaser-game canvas { 
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0; 
        }

        #loginUI, #finalLogo {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; 
            text-align: center;
            gap: 10px; 
            box-sizing: border-box;
            padding: 15px;
        }

        #loginUI {
            background: linear-gradient(to bottom, #000000cc, #000000ee),
            url('assets/background.jpg') no-repeat center center/cover;
        }

        #loginUI img {
            width: 100px;
            max-width: 25%;
            height: auto;
            margin-bottom: 5px;
        }

        #loginUI h1 {
            color: #FFD700;
            font-size: clamp(18px, 4.5vw, 28px);
            margin: 0;
        }

        #loginUI p {
            color: #ffffff;
            font-size: clamp(13px, 3.2vw, 16px);
            max-width: 90%;
        }

        #loginUI input, #loginUI button {
            padding: 10px 18px;
            font-size: clamp(13px, 3.2vw, 16px);
            border-radius: 8px;
            border: none;
        }

        #loginUI input {
            width: 80%;
            max-width: 280px;
        }

        #loginUI button {
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        #loginUI button:hover {
            background-color: #e6c200;
        }

        #finalLogo {
            display: none; 
        }

        #finalLogo h2 {
            font-size: clamp(18px, 5vw, 28px); 
            color: #FFD700;
            margin-bottom: 3px; 
        }

        #finalLogo p {
            font-size: clamp(14px, 3.5vw, 18px); 
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 10px; 
        }
        
        #insigniaCanvas {
            display: block; 
            margin: 0 auto; 
            max-width: 80vw;   
            max-height: 60vh;  
            width: auto; 
            height: auto; 
            object-fit: contain; 
        }

        /* Estilos para UI HTML de MapScene (Solo Header) */
        #mapHeader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px; /* Ajustar seg√∫n sea necesario */
            box-sizing: border-box;
            text-align: center;
            z-index: 10; 
            background-color: rgba(0,0,0,0.8); 
            border-bottom: 1px solid rgba(0, 221, 0, 0.7); 
            display: none; 
        }
        #mapTitle {
            color: #FFD700;
            font-size: clamp(12px, 2vw, 18px); /* Consistente con MapScene */
            font-weight: bold;
            margin: 0 0 3px 0;
            text-shadow: 0.5px 0.5px 1px #000;
        }
        #mapDescription {
            color: #E0E0E0;
            font-size: clamp(9px, 1.6vw, 13px); /* Consistente con MapScene */
            margin: 0;
            text-shadow: 0.5px 0.5px 1px #000;
        }
        /* Ya no se necesita #mapModulesContainer ni .map-module */

        #bottomBarContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #000000; 
            z-index: 25; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
        }

        .touch-controls {
            width: 100%; 
            box-sizing: border-box;
            padding: 8px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            border-top: 2px solid #00FF00; 
        }

        .touch-controls button {
            padding: 10px 16px;
            font-size: clamp(18px, 4.5vw, 22px);
            border-radius: 8px;
            border: none;
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            min-width: 55px;
            text-align: center;
            box-shadow: 0px 1px 3px rgba(0,0,0,0.2);
        }
        .touch-controls button:active {
            background-color: #e6c200;
        }

        .logo-footer {
            width: 60px;
            max-width: 15%;
            height: auto;
            margin-top: 5px; 
            margin-bottom: 5px; 
        }


        @media (max-width: 600px) {
            #loginUI h1 { font-size: clamp(18px, 5.5vw, 26px); }
            #loginUI p { font-size: clamp(12px, 3.5vw, 15px); }
            #loginUI input, #loginUI button {
                font-size: clamp(12px, 3.5vw, 15px);
                padding: 8px 12px;
            }
            #finalLogo h2 { font-size: clamp(16px, 6vw, 24px); }
            #finalLogo p { font-size: clamp(13px, 3.8vw, 16px); }
            #insigniaCanvas { max-width: 75vw; max-height: 55vh; }

            #mapTitle { font-size: clamp(13px, 3.2vw, 20px); }
            #mapDescription { font-size: clamp(10px, 2.5vw, 14px); }


            .touch-controls { padding: 6px 0; gap: 10px; }
            .touch-controls button { font-size: clamp(16px, 4vw, 20px); padding: 8px 12px; min-width: 50px; }
            .logo-footer { width: 50px; margin-top: 3px; margin-bottom: 3px; }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #loginUI h1, #loginUI p, #loginUI input, #loginUI button,
            #finalLogo h2, #finalLogo p { font-size: clamp(11px, 2.2vw, 14px); }
            #loginUI p { font-size: clamp(10px, 2vw, 12px); }
            #insigniaCanvas { max-width: 50vw; max-height: 70vh; }

            #mapTitle { font-size: clamp(12px, 2vw, 18px); }
            #mapDescription { font-size: clamp(9px, 1.6vw, 13px); }


            .touch-controls { padding: 5px 0; }
            .touch-controls button { font-size: clamp(14px, 3.5vw, 16px); padding: 6px 10px; }
            #loginUI img { margin-bottom: 3px; max-width: 18%; }
            #loginUI, #finalLogo { gap: 8px; }
            .logo-footer { width: 45px; margin-top: 2px; margin-bottom: 2px;}
        }
    </style>
</head>
<body>
<div id="phaser-game">
    </div>

<div id="loginUI">
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha">
    <h1>¬°Bienvenido a la Feria de Ciberseguridad! 5</h1>
    <p>Demuestra tu conocimiento Ciberguardi√°n en protecci√≥n digital. Supera los retos, responde las trivias y conquista la galaxia de la ciberseguridad.</p>
    <input type="text" id="usernameInput" placeholder="Ingresa tu nombre">
    <button onclick="startGame()">Comenzar misi√≥n</button>
</div>

<div id="mapHeader">
    <div id="mapTitle"></div>
    <div id="mapDescription"></div>
</div>
<div id="finalLogo">
    <div style="text-align: center; color: white;">
        <h2 style="color: #FFD700;">¬°MISI√ìN CUMPLIDA!</h2>
        <p style="color: #ffffff;">Has superado todos los desaf√≠os y obtuviste tu insignia Ciberguardi√°n ‚≠ê</p>
    </div>
    <canvas id="insigniaCanvas"></canvas> 
</div>

<div id="bottomBarContainer">
    <div class="touch-controls" id="touchControls">
        <button onclick="moveLeft()">‚¨ÖÔ∏è</button>
        <button onclick="enterScene()">üöÄ</button>
        <button onclick="moveRight()">‚û°Ô∏è</button>
    </div>
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha" class="logo-footer" id="logoFooter">
</div>


<script>
let userSession = {
    username: '',
    completedStages: [false, false, false] 
};

let gameInstance = null;
let currentMapScene = null;

const GLOBAL_FONT_FAMILY_HTML = 'Segoe UI, Arial, sans-serif'; // Para HTML
const GLOBAL_FONT_FAMILY_PHASER = 'Arial, sans-serif'; // Fuente segura para Phaser si se usa texto
const MODULE_COUNT = 3; 

// Elementos HTML de la UI del Mapa
let mapHeaderDiv, mapTitleDiv, mapDescriptionDiv;

function createSceneBackground(scene) {
    scene.bg = scene.add.image(scene.scale.width / 2, scene.scale.height / 2, 'background')
        .setDisplaySize(scene.scale.width, scene.scale.height)
        .setDepth(-1); 

    scene.overlay = scene.add.rectangle(0, 0, scene.scale.width, scene.scale.height, 0x000000, 0.75)
        .setOrigin(0)
        .setDepth(-0.5); 
}

function resizeSceneBackground(scene) {
    if (scene.bg) {
        scene.bg.setPosition(scene.scale.width / 2, scene.scale.height / 2)
                 .setDisplaySize(scene.scale.width, scene.scale.height);
    }
    if (scene.overlay) {
        scene.overlay.setSize(scene.scale.width, scene.scale.height);
    }
}

class MapScene extends Phaser.Scene {
    constructor() { 
        super('MapScene');
        this.moduleSprites = []; // Para almacenar los sprites de los m√≥dulos (icono y texto)
        this.activeModuleSpriteIcon = null; // Para el icono del m√≥dulo activo
    }

    preload() {
        this.load.image('background', 'assets/background.jpg');
        this.load.image('module', 'assets/module.png'); // Cargar imagen de m√≥dulo normal
        this.load.image('module-complete', 'assets/module-green.png'); // Cargar imagen de m√≥dulo completado
        this.load.image('character', 'assets/jedi.png'); 
    }

    create() {
        currentMapScene = this;
        this.hideHtmlUI(); 
        
        mapHeaderDiv = document.getElementById('mapHeader');
        mapTitleDiv = document.getElementById('mapTitle');
        mapDescriptionDiv = document.getElementById('mapDescription');
        
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'flex'; 
        if (mapHeaderDiv) mapHeaderDiv.style.display = 'block';

        createSceneBackground(this); 

        this.drawSceneElements(); 
        this.cursors = this.input.keyboard.createCursorKeys();
        this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

        this.scale.on('resize', this.handleResize, this);
        this.updateActiveModuleVisuals(); 
    }

    hideHtmlUI() {
        const mapH = document.getElementById('mapHeader');
        if(mapH) mapH.style.display = 'none';
        document.getElementById('finalLogo').style.display = 'none';
    }


    handleResize() {
        resizeSceneBackground(this);
        // Destruir elementos de Phaser
        this.moduleSprites.forEach(spriteGroup => { 
            if(spriteGroup.icon) spriteGroup.icon.destroy();
            if(spriteGroup.text) spriteGroup.text.destroy();
        });
        this.moduleSprites = [];
        if (this.character) this.character.destroy();
        
        this.drawSceneElements(); 
        this.updateActiveModuleVisuals(); 
    }

    drawSceneElements() { 
        const width = this.scale.width;
        const height = this.scale.height;
        this.isLandscape = width > height;

        // Actualizar texto del header HTML
        mapTitleDiv.textContent = `Hola ${userSession.username.split(' ')[0]}, Ciberguardi√°n`;
        mapDescriptionDiv.textContent = `Supera las misiones y demuestra tu destreza.`;
        
        // Ajustar padding del header HTML basado en la altura real del header de Phaser
        const headerHeightPercentage = this.isLandscape ? 0.14 : 0.11; 
        mapHeaderDiv.style.paddingTop = `${height * headerHeightPercentage * 0.15}px`;
        mapHeaderDiv.style.paddingBottom = `${height * headerHeightPercentage * 0.15}px`;
        
        // M√≥dulos como sprites de Phaser
        const baseIconSize = this.isLandscape ? Math.min(width * 0.06, 45) : Math.min(width * 0.11, 50); // Un poco m√°s peque√±os
        const moduleTextFontSize = this.isLandscape ? 'clamp(8px, 1.5vw, 11px)' : 'clamp(9px, 2.2vw, 12px)';
        
        this.modulePositions = []; 
        const headerActualHeight = mapHeaderDiv.offsetHeight || height * headerHeightPercentage;


        if (this.isLandscape) {
            const moduleAreaY = headerActualHeight + (height - headerActualHeight) * 0.65; 
            const totalModuleWidth = width * 0.5; 
            const moduleSpacingX = totalModuleWidth / (MODULE_COUNT > 1 ? MODULE_COUNT -1 : 1); 
            let currentX = (width - (moduleSpacingX * (MODULE_COUNT - 1))) / 2;

            for (let i = 0; i < MODULE_COUNT; i++) {
                this.modulePositions.push({ x: currentX, y: moduleAreaY });
                currentX += moduleSpacingX;
            }
        } else { 
            const moduleAreaX = width / 2;
            const moduleGroupHeight = (height - headerActualHeight) * 0.5; 
            const startY = headerActualHeight + (height - headerActualHeight) * 0.3;
            const moduleSpacingY = moduleGroupHeight / (MODULE_COUNT > 1 ? MODULE_COUNT -1 : 1) * 0.9;

            for (let i = 0; i < MODULE_COUNT; i++) {
                this.modulePositions.push({ x: moduleAreaX, y: startY + (i * moduleSpacingY) });
            }
        }
        
        this.currentNode = this.currentNode !== undefined ? this.currentNode : 0;

        this.moduleSprites = this.modulePositions.map((pos, i) => {
            const isComplete = userSession.completedStages?.[i];
            const iconKey = isComplete ? 'module-complete' : 'module';
            
            const icon = this.add.image(pos.x, pos.y, iconKey)
                .setDepth(1)
                .setDisplaySize(baseIconSize, baseIconSize)
                .setInteractive({ useHandCursor: true })
                .on('pointerdown', () => {
                    this.currentNode = i;
                    this.moveCharacter();
                });

            const textObj = this.add.text(pos.x, pos.y + baseIconSize * 0.6, `Fase ${i + 1}`, {
                fontSize: moduleTextFontSize,
                fontFamily: GLOBAL_FONT_FAMILY_PHASER,
                fill: '#E0E0E0', 
                align: 'center',
                shadow: { offsetX: 0.5, offsetY: 0.5, color: '#000', blur: 1}
            }).setOrigin(0.5).setDepth(1.1);
            
            return { icon: icon, text: textObj, originalScale: icon.scaleX };
        });
        
        const baseCharacterSizeWidth = this.isLandscape ? Math.min(width * 0.045, 38) : Math.min(width * 0.08, 45);
        const baseCharacterSizeHeight = baseCharacterSizeWidth * 1.3;

        if (this.moduleSprites[this.currentNode]?.icon) {
            const activeModuleIcon = this.moduleSprites[this.currentNode].icon;
            this.character = this.add.image(
                activeModuleIcon.x, 
                activeModuleIcon.y - activeModuleIcon.displayHeight / 2 - baseCharacterSizeHeight * 0.4, 
                'character'
            ).setDepth(2).setDisplaySize(baseCharacterSizeWidth, baseCharacterSizeHeight);
        }
    }
    
    updateActiveModuleVisuals() {
        this.moduleSprites.forEach((spriteGroup, index) => {
            if (spriteGroup.icon && spriteGroup.icon.active) {
                spriteGroup.icon.clearTint();
                spriteGroup.icon.setScale(spriteGroup.originalScale);
                spriteGroup.text.setStyle({ fill: '#E0E0E0' });


                if (index === this.currentNode) {
                    this.activeModuleSpriteIcon = spriteGroup.icon;
                    this.activeModuleSpriteIcon.setTint(0xFFFF99); // Tinte amarillo sutil
                    this.activeModuleSpriteIcon.setScale(spriteGroup.originalScale * 1.05); // Ligeramente m√°s grande
                    spriteGroup.text.setStyle({ fill: '#FFD700' });
                }
            }
        });
    }

    update() {
        if (!this.cursors) return;
        let moved = false;
        if (Phaser.Input.Keyboard.JustDown(this.cursors.right) && this.currentNode < (MODULE_COUNT - 1)) {
            this.currentNode++;
            moved = true;
        } else if (Phaser.Input.Keyboard.JustDown(this.cursors.left) && this.currentNode > 0) {
            this.currentNode--;
            moved = true;
        }
        if(moved) this.moveCharacter();
        if (Phaser.Input.Keyboard.JustDown(this.enterKey)) enterScene();
    }

    moveCharacter(animate = true) {
        this.updateActiveModuleVisuals(); 

        const activeModuleIcon = this.moduleSprites?.[this.currentNode]?.icon;
        if (activeModuleIcon && this.character && this.character.active) {
            const targetX = activeModuleIcon.x;
            const targetY = activeModuleIcon.y - activeModuleIcon.displayHeight * activeModuleIcon.scaleY / 2 - this.character.displayHeight * 0.4; 

            if (animate && this.character.scene) {
                this.tweens.add({
                    targets: this.character, x: targetX, y: targetY,
                    ease: 'Sine.easeInOut', duration: 250 
                });
            } else {
                this.character.x = targetX; this.character.y = targetY;
            }
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
        if (mapHeaderDiv) mapHeaderDiv.style.display = 'none';
    }
}

class TriviaScene extends Phaser.Scene { // Sin cambios mayores, se mantiene en Phaser
    constructor() { super('TriviaScene'); }
    init(data) {
        this.stage = data.stage; this.selectedOption = null;
        this.optionTexts = []; this.uiElements = [];
    }
    preload() {
        if (!this.textures.exists('background')) this.load.image('background', 'assets/background.jpg');
    }
    create() {
        document.getElementById('mapHeader').style.display = 'none';
        document.getElementById('finalLogo').style.display = 'none';
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'none'; 
        createSceneBackground(this);
        this.drawTriviaUI();
        this.scale.on('resize', this.handleResize, this);
    }
    handleResize() {
        resizeSceneBackground(this);
        this.uiElements.forEach(el => { if(el && el.destroy) el.destroy(); });
        this.uiElements = []; this.optionTexts = [];
        this.drawTriviaUI();
    }
    drawTriviaUI() {
        const centerX = this.scale.width / 2; const centerY = this.scale.height / 2;
        const isLandscape = this.scale.width > this.scale.height; const verticalScale = isLandscape ? 0.85 : 0.95; 
        const titleY = centerY * (isLandscape ? 0.22 : 0.15) * verticalScale; 
        const title = this.add.text(centerX, titleY, `Trivia Fase ${this.stage}`, {
            fontSize: `clamp(${isLandscape ? '15px' : '18px'}, 4.5vw, ${isLandscape ? '22px' : '26px'})`, 
            fill: '#FFD700', fontFamily: GLOBAL_FONT_FAMILY_PHASER, align: 'center',
            stroke: '#000000', strokeThickness: 1,
            shadow: { offsetX: 1, offsetY: 1, color: '#000000', blur: 2, stroke: true, fill: true }
        }).setOrigin(0.5).setDepth(1); this.uiElements.push(title);
        const questionY = centerY * (isLandscape ? 0.42 : 0.35) * verticalScale; 
        const question = this.add.text(centerX, questionY, '¬øQu√© es phishing?', {
            fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.5vw, ${isLandscape ? '17px' : '19px'})`, 
            fill: '#ffffff', fontFamily: GLOBAL_FONT_FAMILY_PHASER, align: 'center', 
            wordWrap: { width: this.scale.width * 0.85, useAdvancedWrap: true },
            shadow: { offsetX: 1, offsetY: 1, color: '#000000', blur: 1, fill: true }
        }).setOrigin(0.5).setDepth(1); this.uiElements.push(question);
        const opciones = ['Una t√©cnica para pescar', 'Un intento de enga√±ar a usuarios para robar datos', 'Un software antivirus'];
        const optionsStartY = centerY * (isLandscape ? 0.68 : 0.60) * verticalScale; 
        const optionHeight = this.scale.height * (isLandscape ? 0.08 : 0.07); 
        const optionSpacing = optionHeight * 1.25; 
        this.optionTexts = opciones.map((op, i) => {
            const yPos = optionsStartY + i * optionSpacing;
            const txt = this.add.text(centerX, yPos, op, {
                fontSize: `clamp(${isLandscape ? '11px' : '13px'}, 3vw, ${isLandscape ? '15px' : '17px'})`, 
                fill: '#ffffff', backgroundColor: '#282828', fontFamily: GLOBAL_FONT_FAMILY_PHASER, 
                padding: { left: 10, right: 10, top: 7, bottom: 7 }, 
                align: 'center', wordWrap: { width: this.scale.width * 0.75, useAdvancedWrap: true },
            }).setOrigin(0.5).setDepth(1).setInteractive({ useHandCursor: true }).on('pointerdown', () => this.seleccionarOpcion(i));
            this.uiElements.push(txt); return txt;
        });
        const confirmBtnY = optionsStartY + opciones.length * optionSpacing + optionHeight * 0.4;
        this.confirmButton = this.add.text(centerX, confirmBtnY, 'Responder', {
            fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.8vw, ${isLandscape ? '17px' : '19px'})`, 
            fill: '#000000', backgroundColor: '#FFD700', fontFamily: GLOBAL_FONT_FAMILY_PHASER,
            padding: { left: 18, right: 18, top: 9, bottom: 9 }, 
            shadow: { offsetX: 0.5, offsetY: 0.5, color: '#000000', blur: 1, fill: true}
        }).setOrigin(0.5).setInteractive({ useHandCursor: true }).setVisible(false).setDepth(1);
        this.uiElements.push(this.confirmButton); this.confirmButton.on('pointerdown', () => this.validarRespuesta());
        if (this.selectedOption !== null && this.optionTexts?.[this.selectedOption]) {
            this.seleccionarOpcion(this.selectedOption, this.confirmButton.visible);
        }
    }
    seleccionarOpcion(index, showConfirmButton = true) {
        this.selectedOption = index;
        this.optionTexts.forEach((txt, i) => {
            if (txt && txt.active) txt.setStyle({ backgroundColor: i === index ? '#FFD700' : '#282828', fill: i === index ? '#000000' : '#FFFFFF' });
        });
        if (this.confirmButton && this.confirmButton.active) this.confirmButton.setVisible(showConfirmButton);
    }
    validarRespuesta() {
        if (this.selectedOption === null || !this.optionTexts?.[this.selectedOption]) return;
        const opcion = this.optionTexts?.[this.selectedOption]?.text;
        if (opcion?.includes('enga√±ar')) {
            userSession.completedStages[this.stage - 1] = true; 
            const todasCompletadas = userSession.completedStages.every(e => e === true);
            this.scale.off('resize', this.handleResize, this);
            this.scene.start(todasCompletadas ? 'BadgeScene' : 'MapScene');
        } else {
            if (this.incorrectMsg && this.incorrectMsg.destroy) this.incorrectMsg.destroy();
            const isLandscape = this.scale.width > this.scale.height;
            this.incorrectMsg = this.add.text(this.scale.width/2, this.scale.height * (isLandscape ? 0.92 : 0.95), '‚ùå Respuesta incorrecta. Intenta otra vez.', {
                fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.8vw, ${isLandscape ? '17px' : '19px'})`, fill: '#ff0000', 
                backgroundColor: 'rgba(0,0,0,0.7)', fontFamily: GLOBAL_FONT_FAMILY_PHASER, padding: {x:8, y:5}, 
                shadow: { offsetX: 1, offsetY: 1, color: '#000000', blur: 1, fill: true}
            }).setOrigin(0.5).setDepth(2); this.uiElements.push(this.incorrectMsg);
            this.optionTexts.forEach(txt => txt.disableInteractive());
            if(this.confirmButton) this.confirmButton.disableInteractive().setVisible(false);
            this.time.delayedCall(2000, () => {
                if(this.scene.key === 'TriviaScene') {
                    this.scale.off('resize', this.handleResize, this); this.scene.start('MapScene');
                }
            });
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
        this.uiElements.forEach(el => { if(el && typeof el.destroy === 'function') el.destroy(); });
        this.uiElements = []; this.optionTexts = [];
        if (this.incorrectMsg && typeof this.incorrectMsg.destroy === 'function') this.incorrectMsg.destroy();
    }
}

class BadgeScene extends Phaser.Scene { // Sin cambios
    constructor() { super('BadgeScene'); }
    preload() {
        if (!this.textures.exists('background')) this.load.image('background', 'assets/background.jpg');
        this.load.image('insigniaBP', 'assets/insigniaBP.png');
    }
    create() {
        document.getElementById('mapHeader').style.display = 'none';
        document.getElementById('finalLogo').style.display = 'flex';
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'none'; 
        createSceneBackground(this);
        this.drawDynamicInsignia(userSession.username);
    }
    drawDynamicInsignia(nombre) {
        const canvas = document.getElementById('insigniaCanvas'); if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const imgTexture = this.textures.get('insigniaBP');
        if (!imgTexture || imgTexture.key === '__MISSING') {
            console.error("Textura insignia no cargada."); canvas.width = 200; canvas.height = 50;
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle="red"; ctx.font=`14px ${GLOBAL_FONT_FAMILY_HTML}`;
            ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("Error Insignia",canvas.width/2,canvas.height/2); return;
        }
        const img = imgTexture.getSourceImage(); 
        canvas.width = img.naturalWidth || img.width; canvas.height = img.naturalHeight || img.height;
        ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height);
        const fontSize = Math.max(8, canvas.width * 0.05); 
        ctx.font = `bold ${fontSize}px ${GLOBAL_FONT_FAMILY_HTML}`; ctx.fillStyle = '#000000'; 
        ctx.textAlign = 'center'; ctx.fillText(nombre.toUpperCase(), canvas.width/2, canvas.height * 0.735); 
    }
    shutdown() {}
}

function moveLeft() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode > 0) {
        currentMapScene.currentNode--; currentMapScene.moveCharacter();
    }
}
function moveRight() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode < (MODULE_COUNT - 1)) {
        currentMapScene.currentNode++; currentMapScene.moveCharacter();
    }
}
function enterScene() {
    if (currentMapScene && currentMapScene.sys.isActive()) {
        const index = currentMapScene.currentNode;
        const unlocked = index === 0 || userSession?.completedStages?.[index - 1];
        if (unlocked && currentMapScene.scene.key === 'MapScene') {
            currentMapScene.scene.start('TriviaScene', { stage: index + 1 });
        }
    }
}

function startGame() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    if (username === '') {
        usernameInput.style.border = "2px solid red";
        let errorMsg = document.getElementById('usernameError');
        if (!errorMsg) {
            errorMsg = document.createElement('p'); errorMsg.id = 'usernameError';
            errorMsg.textContent = '¬°El nombre no puede estar vac√≠o!'; errorMsg.style.color = 'red';
            errorMsg.style.fontSize = 'clamp(12px, 3vw, 14px)';
            usernameInput.parentNode.insertBefore(errorMsg, usernameInput.nextSibling);
        } return;
    }
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();
    usernameInput.style.border = "none";
    userSession.username = username;
    userSession.completedStages = Array(MODULE_COUNT).fill(false); 
    document.getElementById('loginUI').style.display = 'none';

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        resolution: window.devicePixelRatio || 1, 
        parent: 'phaser-game', 
        scale: {
            mode: Phaser.Scale.RESIZE,
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        scene: [MapScene, TriviaScene, BadgeScene],
        render: { antialias: true, pixelArt: false },
        pipeline: { PostFX: true }
    };

    if (gameInstance) {
        gameInstance.scene.getScenes(true).forEach(scene => {
            if (scene.sys.isActive() && scene.shutdown) scene.shutdown();
        });
        gameInstance.destroy(true); gameInstance = null;
    }
    gameInstance = new Phaser.Game(config);
}

window.addEventListener('resize', () => { /* Phaser maneja esto */ });
document.addEventListener('DOMContentLoaded', () => {
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();
    const bottomBar = document.getElementById('bottomBarContainer');
    const mapUIHeader = document.getElementById('mapHeader');
    
    if (document.getElementById('loginUI').style.display !== 'none') {
        if (bottomBar) bottomBar.style.display = 'none';
        if (mapUIHeader) mapUIHeader.style.display = 'none';
    }
});

</script>

</body>
</html>
