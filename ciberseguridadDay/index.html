<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ciberseguridad Day</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
        }
        canvas { /* Estilo general para el canvas de Phaser */
            display: block;
            max-width: 100vw;
            max-height: 100vh;
            width: 100%;
            height: 100%;
        }

        #loginUI, #finalLogo {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30; 
            text-align: center;
            gap: 10px; 
            box-sizing: border-box;
            padding: 15px;
        }

        #loginUI {
            background: linear-gradient(to bottom, #000000cc, #000000ee),
            url('assets/background.jpg') no-repeat center center/cover;
        }

        #loginUI img {
            width: 100px;
            max-width: 25%;
            height: auto;
            margin-bottom: 5px;
        }

        #loginUI h1 {
            color: #FFD700;
            font-size: clamp(18px, 4.5vw, 28px);
            margin: 0;
        }

        #loginUI p {
            color: #ffffff;
            font-size: clamp(13px, 3.2vw, 16px);
            max-width: 90%;
        }

        #loginUI input, #loginUI button {
            padding: 10px 18px;
            font-size: clamp(13px, 3.2vw, 16px);
            border-radius: 8px;
            border: none;
        }

        #loginUI input {
            width: 80%;
            max-width: 280px;
        }

        #loginUI button {
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        #loginUI button:hover {
            background-color: #e6c200;
        }

        #finalLogo {
            display: none; 
        }

        #finalLogo h2 {
            font-size: clamp(18px, 5vw, 28px); 
            color: #FFD700;
            margin-bottom: 3px; 
        }

        #finalLogo p {
            font-size: clamp(14px, 3.5vw, 18px); 
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 10px; 
        }
        
        #insigniaCanvas {
            display: block; 
            margin: 0 auto; 
            max-width: 80vw;   
            max-height: 60vh;  
            width: auto; 
            height: auto; 
            object-fit: contain; 
        }


        #bottomBarContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #000000; 
            z-index: 25; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
        }

        .touch-controls {
            width: 100%; 
            box-sizing: border-box;
            padding: 8px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            border-top: 2px solid #00FF00; 
        }

        .touch-controls button {
            padding: 10px 16px;
            font-size: clamp(18px, 4.5vw, 22px);
            border-radius: 8px;
            border: none;
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            min-width: 55px;
            text-align: center;
            box-shadow: 0px 1px 3px rgba(0,0,0,0.2);
        }
        .touch-controls button:active {
            background-color: #e6c200;
        }

        .logo-footer {
            width: 60px;
            max-width: 15%;
            height: auto;
            margin-top: 5px; 
            margin-bottom: 5px; 
        }


        @media (max-width: 600px) {
            #loginUI h1 { font-size: clamp(18px, 5.5vw, 26px); }
            #loginUI p { font-size: clamp(12px, 3.5vw, 15px); }
            #loginUI input, #loginUI button {
                font-size: clamp(12px, 3.5vw, 15px);
                padding: 8px 12px;
            }
            #finalLogo h2 { font-size: clamp(16px, 6vw, 24px); }
            #finalLogo p { font-size: clamp(13px, 3.8vw, 16px); }
            #insigniaCanvas { max-width: 75vw; max-height: 55vh; }


            .touch-controls { padding: 6px 0; gap: 10px; }
            .touch-controls button { font-size: clamp(16px, 4vw, 20px); padding: 8px 12px; min-width: 50px; }
            .logo-footer { width: 50px; margin-top: 3px; margin-bottom: 3px; }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #loginUI h1, #loginUI p, #loginUI input, #loginUI button,
            #finalLogo h2, #finalLogo p { font-size: clamp(11px, 2.2vw, 14px); }
            #loginUI p { font-size: clamp(10px, 2vw, 12px); }
            #insigniaCanvas { max-width: 50vw; max-height: 70vh; }


            .touch-controls { padding: 5px 0; }
            .touch-controls button { font-size: clamp(14px, 3.5vw, 16px); padding: 6px 10px; }
            #loginUI img { margin-bottom: 3px; max-width: 18%; }
            #loginUI, #finalLogo { gap: 8px; }
            .logo-footer { width: 45px; margin-top: 2px; margin-bottom: 2px;}
        }
    </style>
</head>
<body>

<div id="loginUI">
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha">
    <h1>¬°Bienvenido a la Feria de Ciberseguridad! 5</h1>
    <p>Demuestra tu conocimiento Ciberguardi√°n en protecci√≥n digital. Supera los retos, responde las trivias y conquista la galaxia de la ciberseguridad.</p>
    <input type="text" id="usernameInput" placeholder="Ingresa tu nombre">
    <button onclick="startGame()">Comenzar misi√≥n</button>
</div>

<div id="finalLogo">
    <div style="text-align: center; color: white;">
        <h2 style="color: #FFD700;">¬°MISI√ìN CUMPLIDA!</h2>
        <p style="color: #ffffff;">Has superado todos los desaf√≠os y obtuviste tu insignia Ciberguardi√°n ‚≠ê</p>
    </div>
    <canvas id="insigniaCanvas"></canvas> 
</div>

<div id="bottomBarContainer">
    <div class="touch-controls" id="touchControls">
        <button onclick="moveLeft()">‚¨ÖÔ∏è</button>
        <button onclick="enterScene()">üöÄ</button>
        <button onclick="moveRight()">‚û°Ô∏è</button>
    </div>
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha" class="logo-footer" id="logoFooter">
</div>


<script>
let userSession = {
    username: '',
    completedStages: [false, false, false]
};

let gameInstance = null;
let currentMapScene = null;

const GLOBAL_FONT_FAMILY = 'Segoe UI';

function createSceneBackground(scene) {
    scene.bg = scene.add.image(scene.scale.width / 2, scene.scale.height / 2, 'background')
        .setDisplaySize(scene.scale.width, scene.scale.height)
        .setDepth(-1);

    scene.overlay = scene.add.rectangle(0, 0, scene.scale.width, scene.scale.height, 0x000000, 0.75)
        .setOrigin(0)
        .setDepth(-0.5);
}

function resizeSceneBackground(scene) {
    if (scene.bg) {
        scene.bg.setPosition(scene.scale.width / 2, scene.scale.height / 2)
                 .setDisplaySize(scene.scale.width, scene.scale.height);
    }
    if (scene.overlay) {
        scene.overlay.setSize(scene.scale.width, scene.scale.height);
    }
}

class MapScene extends Phaser.Scene {
    constructor() { super('MapScene'); }

    preload() {
        this.load.image('background', 'assets/background.jpg');
        this.load.image('module', 'assets/module.png');
        this.load.image('module-complete', 'assets/module-green.png');
        this.load.image('character', 'assets/jedi.png');
    }

    create() {
        currentMapScene = this;
        document.getElementById('finalLogo').style.display = 'none';
        
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'flex'; 

        createSceneBackground(this);

        this.drawSceneElements();
        this.cursors = this.input.keyboard.createCursorKeys();
        this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

        this.scale.on('resize', this.handleResize, this);
    }

    handleResize() {
        resizeSceneBackground(this);

        if (this.titleText) this.titleText.destroy();
        if (this.descriptionText) this.descriptionText.destroy();
        if (this.headerBgPhaser) this.headerBgPhaser.destroy(); 
        if (this.headerLine) this.headerLine.destroy();
        if (this.moduleSprites) {
            this.moduleSprites.forEach(spriteGroup => {
                if (spriteGroup.icon) spriteGroup.icon.destroy();
                if (spriteGroup.text) spriteGroup.text.destroy();
            });
            this.moduleSprites = [];
        }
        if (this.character) this.character.destroy();

        this.drawSceneElements();
    }

    drawSceneElements() {
        const width = this.scale.width;
        const height = this.scale.height;
        const isLandscape = width > height;

        const headerHeightPercentage = isLandscape ? 0.18 : 0.15;
        const headerHeight = height * headerHeightPercentage;
        const mapHeight = height * (1 - headerHeightPercentage);
        
        this.headerBgPhaser = this.add.rectangle(width / 2, headerHeight / 2, width, headerHeight, 0x000000, 0.85).setDepth(0);

        const titleFontSize = isLandscape ? 'clamp(14px, 2.5vw, 22px)' : 'clamp(16px, 4vw, 24px)';
        this.titleText = this.add.text(width / 2, headerHeight * 0.35,
            `Hola ${userSession.username.split(' ')[0]}, Ciberguardi√°n`, {
                fontSize: titleFontSize, fill: '#FFD700', fontFamily: GLOBAL_FONT_FAMILY, wordWrap: { width: width * 0.9, useAdvancedWrap: true }, align: 'center'
            }).setOrigin(0.5).setDepth(1);

        const descFontSize = isLandscape ? 'clamp(11px, 2vw, 16px)' : 'clamp(12px, 3vw, 17px)';
        this.descriptionText = this.add.text(width / 2, headerHeight * 0.75,
            `Supera las misiones y demuestra tu destreza.`, {
                fontSize: descFontSize, fill: '#ffffff', fontFamily: GLOBAL_FONT_FAMILY, wordWrap: { width: width * 0.95, useAdvancedWrap: true }, align: 'center'
            }).setOrigin(0.5).setDepth(1);

        this.headerLine = this.add.rectangle(width / 2, headerHeight -2, width, 2, 0x00FF00).setDepth(1);

        let moduleBaseY, moduleSpacingY;
        if (isLandscape) {
            moduleBaseY = headerHeight + mapHeight * 0.35;
            moduleSpacingY = mapHeight * 0.15;
            this.modules = [
                { x: width * 0.25, y: moduleBaseY + moduleSpacingY * 0.5 },
                { x: width * 0.5,   y: moduleBaseY + moduleSpacingY * 1.5 },
                { x: width * 0.75, y: moduleBaseY + moduleSpacingY * 0.5 }
            ];
        } else {
            moduleBaseY = headerHeight + mapHeight * 0.2;
            moduleSpacingY = mapHeight * 0.25;
            this.modules = [
                { x: width * 0.25, y: moduleBaseY },
                { x: width * 0.5,   y: moduleBaseY + moduleSpacingY },
                { x: width * 0.75, y: moduleBaseY + moduleSpacingY * 2 }
            ];
        }

        this.currentNode = this.currentNode !== undefined ? this.currentNode : 0;

        this.moduleSprites = this.modules.map((mod, i) => {
            const key = userSession.completedStages?.[i] ? 'module-complete' : 'module';
            const icon = this.add.image(mod.x, mod.y, key).setDepth(1);
            const iconSize = Math.min(width * (isLandscape ? 0.08 : 0.12), isLandscape ? 60 : 70);
            icon.setDisplaySize(iconSize, iconSize);
            const moduleText = this.add.text(mod.x, mod.y + iconSize * 0.8, `Fase ${i + 1}`, {
                fontSize: `clamp(11px, 2.5vw, ${isLandscape ? '14px' : '15px'})`,
                fill: '#fff', fontFamily: GLOBAL_FONT_FAMILY, align: 'center'
            }).setOrigin(0.5).setDepth(1);
            return { icon: icon, text: moduleText };
        });

        const characterSize = Math.min(width * (isLandscape ? 0.07 : 0.1), isLandscape ? 50 : 65);
        const currentModulePos = this.modules?.[this.currentNode];
        if (currentModulePos) {
            this.character = this.add.image(currentModulePos.x, currentModulePos.y - characterSize * 0.9, 'character').setDepth(2);
            this.character.setDisplaySize(characterSize, characterSize);
        } else if (this.modules?.length > 0) {
            this.currentNode = 0;
            const firstModulePos = this.modules[0];
            this.character = this.add.image(firstModulePos.x, firstModulePos.y - characterSize * 0.9, 'character').setDepth(2);
            this.character.setDisplaySize(characterSize, characterSize);
        }
        this.moveCharacter(false);
    }

    update() {
        if (!this.cursors) return;
        if (Phaser.Input.Keyboard.JustDown(this.cursors.right) && this.currentNode < (this.modules?.length - 1 || 0)) {
            this.currentNode++;
            this.moveCharacter();
        } else if (Phaser.Input.Keyboard.JustDown(this.cursors.left) && this.currentNode > 0) {
            this.currentNode--;
            this.moveCharacter();
        }

        if (Phaser.Input.Keyboard.JustDown(this.enterKey)) enterScene();
    }

    moveCharacter(animate = true) {
        const targetModule = this.modules?.[this.currentNode];
        if (targetModule && this.character) {
            const isLandscape = this.scale.width > this.scale.height;
            const characterSize = Math.min(this.scale.width * (isLandscape ? 0.07 : 0.1), isLandscape ? 50 : 65);
            const targetX = targetModule.x;
            const targetY = targetModule.y - characterSize * 0.9;

            if (animate && this.character.scene) {
                this.tweens.add({
                    targets: this.character,
                    x: targetX, y: targetY,
                    ease: 'Power2', duration: 250
                });
            } else {
                this.character.x = targetX;
                this.character.y = targetY;
            }
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
    }
}

class TriviaScene extends Phaser.Scene {
    constructor() { super('TriviaScene'); }

    init(data) {
        this.stage = data.stage;
        this.selectedOption = null;
        this.optionTexts = [];
        this.uiElements = [];
    }

    preload() {
        if (!this.textures.exists('background')) {
            this.load.image('background', 'assets/background.jpg');
        }
    }

    create() {
        document.getElementById('finalLogo').style.display = 'none';
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'none'; 

        createSceneBackground(this);

        this.drawTriviaUI();
        this.scale.on('resize', this.handleResize, this);
    }

    handleResize() {
        resizeSceneBackground(this);

        this.uiElements.forEach(el => { if(el && el.destroy) el.destroy(); });
        this.uiElements = [];
        this.optionTexts = [];

        this.drawTriviaUI();
    }

    drawTriviaUI() {
        const centerX = this.scale.width / 2;
        const centerY = this.scale.height / 2;
        const isLandscape = this.scale.width > this.scale.height;
        const verticalScale = isLandscape ? 0.9 : 1;

        const titleY = isLandscape ? centerY * 0.25 : centerY * 0.2;
        const title = this.add.text(centerX, titleY * verticalScale, `Trivia Fase ${this.stage}`, {
            fontSize: `clamp(${isLandscape ? '18px' : '22px'}, 5.5vw, ${isLandscape ? '26px' : '30px'})`, fill: '#FFD700', fontFamily: GLOBAL_FONT_FAMILY, align: 'center'
        }).setOrigin(0.5).setDepth(1);
        this.uiElements.push(title);

        const questionY = isLandscape ? centerY * 0.5 : centerY * 0.45;
        const question = this.add.text(centerX, questionY * verticalScale, '¬øQu√© es phishing?', {
            fontSize: `clamp(${isLandscape ? '15px' : '17px'}, 4vw, ${isLandscape ? '19px' : '22px'})`, fill: '#ffffff', fontFamily: GLOBAL_FONT_FAMILY, align: 'center', wordWrap: { width: this.scale.width * 0.9, useAdvancedWrap: true }
        }).setOrigin(0.5).setDepth(1);
        this.uiElements.push(question);

        const opciones = [
            'Una t√©cnica para pescar',
            'Un intento de enga√±ar a usuarios para robar datos',
            'Un software antivirus'
        ];

        const optionsStartY = isLandscape ? centerY * 0.8 : centerY * 0.75;
        const optionSpacing = isLandscape ? this.scale.height * 0.15 : this.scale.height * 0.13;

        this.optionTexts = opciones.map((op, i) => {
            const yPosition = (optionsStartY + i * optionSpacing) * verticalScale;
            const optionText = this.add.text(centerX, yPosition, op, {
                fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.5vw, ${isLandscape ? '17px' : '19px'})`, fill: '#ffffff', backgroundColor: '#333', fontFamily: GLOBAL_FONT_FAMILY,
                padding: { left: 10, right: 10, top: 8, bottom: 8 }, align: 'center', wordWrap: { width: this.scale.width * 0.8, useAdvancedWrap: true }
            }).setOrigin(0.5).setDepth(1)
                .setInteractive({ useHandCursor: true })
                .on('pointerdown', () => this.seleccionarOpcion(i));
            this.uiElements.push(optionText);
            return optionText;
        });

        const confirmButtonY = (optionsStartY + opciones.length * optionSpacing) * verticalScale;
        this.confirmButton = this.add.text(centerX, confirmButtonY, 'Responder', {
            fontSize: `clamp(${isLandscape ? '15px' : '17px'}, 4.5vw, ${isLandscape ? '19px' : '21px'})`, fill: '#000', backgroundColor: '#FFD700', fontFamily: GLOBAL_FONT_FAMILY,
            padding: { left: 20, right: 20, top: 10, bottom: 10 }
        }).setOrigin(0.5).setInteractive({ useHandCursor: true }).setVisible(false).setDepth(1);
        this.uiElements.push(this.confirmButton);
        this.confirmButton.on('pointerdown', () => this.validarRespuesta());


        if (this.selectedOption !== null && this.optionTexts?.[this.selectedOption]) {
            this.seleccionarOpcion(this.selectedOption, this.confirmButton.visible);
        }
    }

    seleccionarOpcion(index, showConfirmButton = true) {
        this.selectedOption = index;
        this.optionTexts.forEach((txt, i) => {
            if (txt && txt.active) {
                txt.setStyle({
                    backgroundColor: i === index ? '#FFD700' : '#333',
                    fill: i === index ? '#000' : '#fff'
                });
            }
        });
        if (this.confirmButton && this.confirmButton.active) {
            this.confirmButton.setVisible(showConfirmButton);
        }
    }

    validarRespuesta() {
        if (this.selectedOption === null || !this.optionTexts?.[this.selectedOption]) return;

        const opcion = this.optionTexts?.[this.selectedOption]?.text;
        if (opcion?.includes('enga√±ar')) {
            userSession.completedStages = userSession.completedStages || [false, false, false];
            if (this.stage -1 >=0 && this.stage - 1 < userSession.completedStages.length) {
                userSession.completedStages[(this.stage - 1)] = true;
            }
            const todasCompletadas = userSession.completedStages.every(e => e === true);
            this.scale.off('resize', this.handleResize, this);
            this.scene.start(todasCompletadas ? 'BadgeScene' : 'MapScene');
        } else {
            if (this.incorrectMsg && this.incorrectMsg.destroy) this.incorrectMsg.destroy();

            const isLandscape = this.scale.width > this.scale.height;
            this.incorrectMsg = this.add.text(this.scale.width / 2, this.scale.height * (isLandscape ? 0.92 : 0.95) , '‚ùå Respuesta incorrecta. Intenta otra vez.', {
                fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.8vw, ${isLandscape ? '17px' : '19px'})`, fill: '#ff0000', backgroundColor: 'rgba(0,0,0,0.5)', fontFamily: GLOBAL_FONT_FAMILY, padding: {x:5, y:3}
            }).setOrigin(0.5).setDepth(2);
            this.uiElements.push(this.incorrectMsg);

            this.optionTexts.forEach(txt => txt.disableInteractive());
            if(this.confirmButton) this.confirmButton.disableInteractive().setVisible(false);

            this.time.delayedCall(2000, () => {
                if(this.scene.key === 'TriviaScene') {
                    this.scale.off('resize', this.handleResize, this);
                    this.scene.start('MapScene');
                }
            });
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
        this.uiElements.forEach(el => { if(el && typeof el.destroy === 'function') el.destroy(); });
        this.uiElements = [];
        this.optionTexts = [];
        if (this.incorrectMsg && typeof this.incorrectMsg.destroy === 'function') this.incorrectMsg.destroy();
    }
}

class BadgeScene extends Phaser.Scene {
    constructor() { super('BadgeScene'); }

    preload() {
        if (!this.textures.exists('background')) {
            this.load.image('background', 'assets/background.jpg');
        }
        this.load.image('insigniaBP', 'assets/insigniaBP.png');
    }

    create() {
        document.getElementById('finalLogo').style.display = 'flex';
        const bottomBarContainer = document.getElementById('bottomBarContainer');
        if (bottomBarContainer) bottomBarContainer.style.display = 'none'; 

        createSceneBackground(this);

        this.drawDynamicInsignia(userSession.username);
    }


    drawDynamicInsignia(nombre) {
        const canvas = document.getElementById('insigniaCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        const imgTexture = this.textures.get('insigniaBP');
        if (!imgTexture || imgTexture.key === '__MISSING') {
            console.error("Textura de la insignia 'insigniaBP' no encontrada o no cargada.");
            // Fallback visual en el canvas si la imagen no carga
            canvas.width = 200; // Tama√±o de fallback
            canvas.height = 50;
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.fillStyle = "red";
            ctx.font = `14px ${GLOBAL_FONT_FAMILY}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("Error: Insignia no cargada", canvas.width / 2, canvas.height / 2);
            return;
        }
        
        const img = imgTexture.getSourceImage(); 

        canvas.width = img.naturalWidth || img.width; 
        canvas.height = img.naturalHeight || img.height;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // AJUSTES PARA EL TEXTO DEL NOMBRE:
        // 1. Reducir el tama√±o de la fuente
        const fontSize = Math.max(8, canvas.width * 0.05); // Reducido de 0.07 a 0.05, con un m√≠nimo de 8px
        ctx.font = `bold ${fontSize}px ${GLOBAL_FONT_FAMILY}`;
        ctx.fillStyle = '#000000'; 
        ctx.textAlign = 'center';
        // 2. Ajustar la posici√≥n Y para subir el texto
        // El valor de Y es un porcentaje de la altura del canvas. Un valor m√°s peque√±o lo sube.
        // Prueba con valores alrededor de 0.70 - 0.75 hasta que encaje en la franja dorada.
        ctx.fillText(nombre.toUpperCase(), canvas.width / 2, canvas.height * 0.735); // Subido de 0.78
    }

     shutdown() {
        // No hay listeners de Phaser que necesiten quitarse aqu√≠ si handleResize est√° comentado
    }
}


function moveLeft() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode > 0) {
        currentMapScene.currentNode--;
        currentMapScene.moveCharacter();
    }
}

function moveRight() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode < (currentMapScene.modules?.length - 1 || 0)) {
        currentMapScene.currentNode++;
        currentMapScene.moveCharacter();
    }
}

function enterScene() {
    if (currentMapScene && currentMapScene.sys.isActive()) {
        const index = currentMapScene.currentNode;
        const unlocked = index === 0 || userSession?.completedStages?.[index - 1];
        if (unlocked && currentMapScene.scene.key === 'MapScene') {
            currentMapScene.scene.start('TriviaScene', { stage: index + 1 });
        }
    }
}

function startGame() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    if (username === '') {
        usernameInput.style.border = "2px solid red";
        let errorMsg = document.getElementById('usernameError');
        if (!errorMsg) {
            errorMsg = document.createElement('p');
            errorMsg.id = 'usernameError';
            errorMsg.textContent = '¬°El nombre no puede estar vac√≠o!';
            errorMsg.style.color = 'red';
            errorMsg.style.fontSize = 'clamp(12px, 3vw, 14px)';
            usernameInput.parentNode.insertBefore(errorMsg, usernameInput.nextSibling);
        }
        return;
    }
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();

    usernameInput.style.border = "none";
    userSession.username = username;
    userSession.completedStages = [false, false, false];
    document.getElementById('loginUI').style.display = 'none';

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        scale: {
            mode: Phaser.Scale.RESIZE,
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        scene: [MapScene, TriviaScene, BadgeScene],
        render: {
            antialias: true,
            pixelArt: false
        }
    };

    if (gameInstance) {
        gameInstance.scene.getScenes(true).forEach(scene => {
            if (scene.sys.isActive() && scene.shutdown) {
                scene.shutdown();
            }
        });
        gameInstance.destroy(true);
        gameInstance = null;
    }
    gameInstance = new Phaser.Game(config);
}

window.addEventListener('resize', () => {
    // Phaser's scale manager handles resizing the game canvas.
});

document.addEventListener('DOMContentLoaded', () => {
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();

    const bottomBarContainer = document.getElementById('bottomBarContainer');
    if (document.getElementById('loginUI').style.display !== 'none') {
        if (bottomBarContainer) bottomBarContainer.style.display = 'none';
    }
});

</script>

</body>
</html>
