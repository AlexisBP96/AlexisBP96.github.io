<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ciberseguridad Day</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            /* A√±adir un padding inferior para dejar espacio al footer y controles */
            /* padding-bottom: 70px;  Considerar esto si el contenido principal fuera scrolleable */
        }
        canvas {
            display: block;
            max-width: 100vw;
            max-height: 100vh;
            width: 100%;
            height: 100%;
        }

        #loginUI, #finalLogo {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10; /* Subir z-index para que est√© por encima del canvas de Phaser */
            text-align: center;
            gap: 15px; /* Reducir un poco el gap */
            box-sizing: border-box;
            padding: 15px;
        }

        #loginUI {
            background: linear-gradient(to bottom, #000000cc, #000000ee),
            url('assets/background.jpg') no-repeat center center/cover;
        }

        #loginUI img {
            width: 100px;
            max-width: 25%;
            height: auto;
            margin-bottom: 5px;
        }

        .logo-footer {
            position: fixed;
            bottom: 10px; /* Ligeramente m√°s arriba */
            left: 50%;
            transform: translateX(-50%);
            width: 70px; /* Un poco m√°s peque√±o */
            max-width: 18%;
            height: auto;
            z-index: 20; /* Asegurar que est√© visible */
        }

        #loginUI h1 {
            color: #FFD700;
            font-size: clamp(18px, 4.5vw, 28px);
            margin: 0;
        }

        #loginUI p {
            color: #ffffff;
            font-size: clamp(13px, 3.2vw, 16px);
            max-width: 90%;
        }

        #loginUI input, #loginUI button {
            padding: 10px 18px;
            font-size: clamp(13px, 3.2vw, 16px);
            border-radius: 8px;
            border: none;
        }

        #loginUI input {
            width: 80%;
            max-width: 280px;
        }

        #loginUI button {
            background-color: #FFD700;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }

        #loginUI button:hover {
            background-color: #e6c200;
        }

        #finalLogo {
            display: none;
            /* z-index ya est√° en 10 */
        }

        #finalLogo h2 {
            font-size: clamp(20px, 5.5vw, 32px);
            color: #FFD700;
        }

        #finalLogo p {
            font-size: clamp(15px, 3.8vw, 20px);
            color: #ffffff;
        }

        .touch-controls {
            position: fixed;
            /* Ajustar bottom para que est√© encima del footer y con m√°s espacio */
            bottom: 55px; /* Incrementar esta distancia. Original era 20px, luego 55px puede ser un buen punto de partida*/
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 25; /* M√°s alto que el footer */
            justify-content: center;
        }

        .touch-controls button {
            padding: 10px 16px;
            font-size: clamp(18px, 5vw, 24px);
            border-radius: 10px;
            border: none;
            background-color: rgba(255, 215, 0, 0.85); /* Ligeramente transparente para ver a trav√©s */
            color: #000;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.3); /* A√±adir una sombra sutil */
        }
        .touch-controls button:active {
            background-color: rgba(220, 180, 0, 0.95); /* Oscurecer al presionar */
        }


        @media (max-width: 600px) {
            #loginUI h1 {
                font-size: clamp(18px, 5.5vw, 26px);
            }
            #loginUI p {
                font-size: clamp(12px, 3.5vw, 15px);
            }
            #loginUI input, #loginUI button {
                font-size: clamp(12px, 3.5vw, 15px);
                padding: 8px 12px;
            }
            #finalLogo h2 {
                font-size: clamp(18px, 6.5vw, 28px);
            }
            #finalLogo p {
                font-size: clamp(14px, 4vw, 18px);
            }
            .touch-controls {
                bottom: 50px; /* Ajustar si es necesario para pantallas m√°s peque√±as */
            }
            .touch-controls button {
                font-size: clamp(16px, 5vw, 20px);
                padding: 8px 12px;
                min-width: 50px;
            }
            .logo-footer {
                width: 60px;
                bottom: 8px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #loginUI h1, #loginUI p, #loginUI input, #loginUI button,
            #finalLogo h2, #finalLogo p {
                font-size: clamp(11px, 2.2vw, 14px);
            }
             #loginUI p {
                font-size: clamp(10px, 2vw, 12px);
            }
            .touch-controls {
                bottom: 45px; /* Ajustar para landscape peque√±o */
            }
            .touch-controls button {
                font-size: clamp(14px, 3.5vw, 16px);
                padding: 6px 10px;
            }
            #loginUI img {
                margin-bottom: 3px;
                max-width: 18%;
            }
             #loginUI, #finalLogo {
                gap: 8px;
            }
            .logo-footer {
                width: 50px;
                bottom: 5px;
            }
        }
    </style>
</head>
<body>

<div id="loginUI">
    <img src="assets/logo-pichincha.png" alt="Banco Pichincha">
    <h1>¬°Bienvenido a la Feria de Ciberseguridad! 4</h1>
    <p>Demuestra tu conocimiento Ciberguardi√°n en protecci√≥n digital. Supera los retos, responde las trivias y conquista la galaxia de la ciberseguridad.</p>
    <input type="text" id="usernameInput" placeholder="Ingresa tu nombre">
    <button onclick="startGame()">Comenzar misi√≥n</button>
</div>

<div id="finalLogo">
    <div style="text-align: center; color: white;">
        <h2 style="color: #FFD700;">¬°MISI√ìN CUMPLIDA!</h2>
        <p style="color: #ffffff;">Has superado todos los desaf√≠os y obtuviste tu insignia Ciberguardi√°n ‚≠ê</p>
    </div>
    <canvas id="insigniaCanvas" width="300" height="300"></canvas>
</div>

<img src="assets/logo-pichincha.png" alt="Banco Pichincha" class="logo-footer">

<div class="touch-controls" id="touchControls" style="display: none;">
    <button onclick="moveLeft()">‚¨ÖÔ∏è</button>
    <button onclick="enterScene()">üöÄ</button>
    <button onclick="moveRight()">‚û°Ô∏è</button>
</div>

<script>
let userSession = {
    username: '',
    completedStages: [false, false, false]
};

let gameInstance = null;
let currentMapScene = null;

class MapScene extends Phaser.Scene {
    constructor() { super('MapScene'); }

    preload() {
        this.load.image('background', 'assets/background.jpg');
        this.load.image('module', 'assets/module.png');
        this.load.image('module-complete', 'assets/module-green.png');
        this.load.image('character', 'assets/jedi.png');
    }

    create() {
        currentMapScene = this;
        document.getElementById('finalLogo').style.display = 'none';
        const touchControls = document.getElementById('touchControls');
        if (touchControls) touchControls.style.display = 'flex';

        this.drawScene();
        this.cursors = this.input.keyboard.createCursorKeys();
        this.enterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

        this.scale.on('resize', this.handleResize, this);
    }

    handleResize() {
        // Destruir elementos espec√≠ficos para evitar duplicados
        if (this.titleText) this.titleText.destroy();
        if (this.descriptionText) this.descriptionText.destroy();
        if (this.headerBg) this.headerBg.destroy();
        if (this.headerLine) this.headerLine.destroy();
        if (this.mapBg) this.mapBg.destroy();
        if (this.moduleSprites) {
            this.moduleSprites.forEach(spriteGroup => {
                if (spriteGroup.icon) spriteGroup.icon.destroy();
                if (spriteGroup.text) spriteGroup.text.destroy();
            });
            this.moduleSprites = []; // Limpiar el array
        }
        if (this.character) this.character.destroy();

        this.drawScene(); // Volver a dibujar la escena con las nuevas dimensiones
    }

    drawScene() {
        const width = this.scale.width;
        const height = this.scale.height;
        const isLandscape = width > height;

        // *** AJUSTE PRINCIPAL AQU√ç: Reducir la altura del header ***
        const headerHeightPercentage = isLandscape ? 0.18 : 0.15; // Reducido de 0.3/0.25
        const headerHeight = height * headerHeightPercentage;
        const mapHeight = height * (1 - headerHeightPercentage);

        this.headerBg = this.add.rectangle(width / 2, headerHeight / 2, width, headerHeight, 0x000000, 0.9);

        // Ajustar tama√±o de fuente y posici√≥n de textos del header
        const titleFontSize = isLandscape ? 'clamp(14px, 2.5vw, 20px)' : 'clamp(16px, 4vw, 22px)';
        this.titleText = this.add.text(width / 2, headerHeight * 0.35, // Ajustar Y para centrar mejor
         `Hola ${userSession.username.split(' ')[0]}, Ciberguardi√°n`, { // Nombre m√°s corto
            fontSize: titleFontSize, fill: '#FFD700', fontFamily: 'Segoe UI', wordWrap: { width: width * 0.9, useAdvancedWrap: true }, align: 'center'
        }).setOrigin(0.5);

        const descFontSize = isLandscape ? 'clamp(11px, 2vw, 15px)' : 'clamp(12px, 3vw, 16px)';
        this.descriptionText = this.add.text(width / 2, headerHeight * 0.75, // Ajustar Y
         `Supera las misiones y demuestra tu destreza.`, { // Texto m√°s corto
            fontSize: descFontSize, fill: '#ffffff', fontFamily: 'Segoe UI', wordWrap: { width: width * 0.95, useAdvancedWrap: true }, align: 'center'
        }).setOrigin(0.5);

        this.headerLine = this.add.rectangle(width / 2, headerHeight -2, width, 4, 0x00FF00); // L√≠nea justo al final del header

        const mapY = headerHeight + mapHeight / 2;
        this.mapBg = this.add.image(width / 2, mapY, 'background').setDisplaySize(width, mapHeight);

        // Ajustar la posici√≥n Y base de los m√≥dulos debido al cambio en headerHeight
        let moduleBaseY, moduleSpacingY;
        if (isLandscape) {
            moduleBaseY = headerHeight + mapHeight * 0.35;
            moduleSpacingY = mapHeight * 0.15;
             this.modules = [
                { x: width * 0.25, y: moduleBaseY + moduleSpacingY * 0.5 },
                { x: width * 0.5,  y: moduleBaseY + moduleSpacingY * 1.5 },
                { x: width * 0.75, y: moduleBaseY + moduleSpacingY * 0.5 }
            ];
        } else { // Portrait
            moduleBaseY = headerHeight + mapHeight * 0.2;
            moduleSpacingY = mapHeight * 0.25; // Mayor espaciado vertical en portrait
            this.modules = [
                { x: width * 0.25, y: moduleBaseY }, // M√≥dulo 1 m√°s arriba
                { x: width * 0.5,  y: moduleBaseY + moduleSpacingY },
                { x: width * 0.75, y: moduleBaseY + moduleSpacingY * 2 } // M√≥dulo 3 m√°s abajo
            ];
        }


        this.currentNode = this.currentNode !== undefined ? this.currentNode : 0;

        this.moduleSprites = this.modules.map((mod, i) => {
            const key = userSession.completedStages?.[i] ? 'module-complete' : 'module';
            const icon = this.add.image(mod.x, mod.y, key);
            const iconSize = Math.min(width * (isLandscape ? 0.07 : 0.11), isLandscape ? 55 : 65);
            icon.setDisplaySize(iconSize, iconSize);
            const moduleText = this.add.text(mod.x, mod.y + iconSize * 0.75, `Fase ${i + 1}`, { fontSize: 'clamp(10px, 2.2vw, 13px)', fill: '#fff', align: 'center' }).setOrigin(0.5);
            return { icon: icon, text: moduleText };
        });

        const characterSize = Math.min(width * (isLandscape ? 0.06 : 0.09), isLandscape ? 45 : 60);
        if (this.modules?.[this.currentNode]) {
             this.character = this.add.image(this.modules[this.currentNode].x, this.modules[this.currentNode].y - characterSize * 1, 'character'); // Un poco m√°s arriba del m√≥dulo
             this.character.setDisplaySize(characterSize, characterSize);
        } else if (this.modules?.length > 0) { // Si currentNode es inv√°lido pero hay m√≥dulos, poner en el primero
            this.currentNode = 0;
            this.character = this.add.image(this.modules[0].x, this.modules[0].y - characterSize * 1, 'character');
            this.character.setDisplaySize(characterSize, characterSize);
        }
        this.moveCharacter(false);
    }

    update() {
        if (!this.cursors) return; // Asegurarse de que los cursores est√°n inicializados
        if (Phaser.Input.Keyboard.JustDown(this.cursors.right) && this.currentNode < (this.modules?.length - 1 || 0)) {
            this.currentNode++;
            this.moveCharacter();
        } else if (Phaser.Input.Keyboard.JustDown(this.cursors.left) && this.currentNode > 0) {
            this.currentNode--;
            this.moveCharacter();
        }

        if (Phaser.Input.Keyboard.JustDown(this.enterKey)) enterScene();
    }

    moveCharacter(animate = true) {
        const target = this.modules?.[this.currentNode];
        if (target && this.character) {
            const isLandscape = this.scale.width > this.scale.height;
            const characterSize = Math.min(this.scale.width * (isLandscape ? 0.06 : 0.09), isLandscape ? 45 : 60);
            const targetX = target.x;
            const targetY = target.y - characterSize * 1;

            if (animate) {
                 this.tweens.add({
                    targets: this.character,
                    x: targetX,
                    y: targetY,
                    ease: 'Power2',
                    duration: 250
                });
            } else {
                this.character.x = targetX;
                this.character.y = targetY;
            }
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
    }
}

class TriviaScene extends Phaser.Scene {
    constructor() { super('TriviaScene'); }

    init(data) {
        this.stage = data.stage;
        this.selectedOption = null;
        this.optionTexts = [];
        this.uiElements = [];
    }

    create() {
        document.getElementById('finalLogo').style.display = 'none';
        const touchControls = document.getElementById('touchControls');
        if (touchControls) touchControls.style.display = 'none';

        this.drawTrivia();
        this.scale.on('resize', this.handleResize, this);
    }

    handleResize() {
        this.uiElements.forEach(el => { if(el && el.destroy) el.destroy(); });
        this.uiElements = [];
        this.drawTrivia();
    }

    drawTrivia() {
        const centerX = this.scale.width / 2;
        const centerY = this.scale.height / 2;
        const isLandscape = this.scale.width > this.scale.height;
        const verticalScale = isLandscape ? 0.9 : 1; // Comprimir menos en landscape

        const titleY = isLandscape ? centerY * 0.25 : centerY * 0.2;
        const title = this.add.text(centerX, titleY * verticalScale, `Trivia Fase ${this.stage}`, {
            fontSize: `clamp(${isLandscape ? '18px' : '22px'}, 5.5vw, ${isLandscape ? '26px' : '30px'})`, fill: '#FFD700', fontFamily: 'Segoe UI', align: 'center'
        }).setOrigin(0.5);
        this.uiElements.push(title);

        const questionY = isLandscape ? centerY * 0.5 : centerY * 0.45;
        const question = this.add.text(centerX, questionY * verticalScale, '¬øQu√© es phishing?', {
            fontSize: `clamp(${isLandscape ? '15px' : '17px'}, 4vw, ${isLandscape ? '19px' : '22px'})`, fill: '#ffffff', fontFamily: 'Segoe UI', align: 'center', wordWrap: { width: this.scale.width * 0.9, useAdvancedWrap: true }
        }).setOrigin(0.5);
        this.uiElements.push(question);

        const opciones = [
            'Una t√©cnica para pescar',
            'Un intento de enga√±ar a usuarios para robar datos',
            'Un software antivirus'
        ];

        // Ajustar posici√≥n de opciones y bot√≥n de confirmar
        const optionsStartY = isLandscape ? centerY * 0.8 : centerY * 0.75;
        const optionSpacing = isLandscape ? this.scale.height * 0.15 : this.scale.height * 0.13;

        this.optionTexts = opciones.map((op, i) => {
            const yPosition = (optionsStartY + i * optionSpacing) * verticalScale;
            const optionText = this.add.text(centerX, yPosition, op, {
                fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.5vw, ${isLandscape ? '17px' : '19px'})`, fill: '#ffffff', backgroundColor: '#333',
                padding: { left: 10, right: 10, top: 8, bottom: 8 }, align: 'center', wordWrap: { width: this.scale.width * 0.8, useAdvancedWrap: true }
            }).setOrigin(0.5)
                .setInteractive({ useHandCursor: true })
                .on('pointerdown', () => this.seleccionarOpcion(i));
            this.uiElements.push(optionText);
            return optionText;
        });

        const confirmButtonY = (optionsStartY + opciones.length * optionSpacing) * verticalScale;
        this.confirmButton = this.add.text(centerX, confirmButtonY, 'Responder', {
            fontSize: `clamp(${isLandscape ? '15px' : '17px'}, 4.5vw, ${isLandscape ? '19px' : '21px'})`, fill: '#000', backgroundColor: '#FFD700',
            padding: { left: 20, right: 20, top: 10, bottom: 10 }
        }).setOrigin(0.5).setInteractive({ useHandCursor: true }).setVisible(false)
            .on('pointerdown', () => this.validarRespuesta());
        this.uiElements.push(this.confirmButton);

        if (this.selectedOption !== null && this.optionTexts[this.selectedOption]) {
            this.seleccionarOpcion(this.selectedOption, this.confirmButton.visible);
        }
    }

    seleccionarOpcion(index, showConfirmButton = true) {
        this.selectedOption = index;
        this.optionTexts.forEach((txt, i) => {
            if (txt && txt.active) { // Verificar que el texto exista y est√© activo
                txt.setStyle({
                    backgroundColor: i === index ? '#FFD700' : '#333',
                    fill: i === index ? '#000' : '#fff'
                });
            }
        });
        if (this.confirmButton && this.confirmButton.active) {
            this.confirmButton.setVisible(showConfirmButton);
        }
    }

    validarRespuesta() {
        if (this.selectedOption === null || !this.optionTexts?.[this.selectedOption]) return;

        this.scale.off('resize', this.handleResize, this);

        const opcion = this.optionTexts[this.selectedOption].text;
        if (opcion.includes('enga√±ar')) {
            userSession.completedStages = userSession.completedStages || [false, false, false];
            if (this.stage -1 >=0 && this.stage - 1 < userSession.completedStages.length) {
                userSession.completedStages[(this.stage - 1)] = true;
            }
            const todas = userSession.completedStages.every(e => e === true);
            this.scene.start(todas ? 'BadgeScene' : 'MapScene');
        } else {
            this.uiElements.forEach(el => {if(el && el.destroy) el.destroy()});
            this.uiElements = [];
            this.drawTrivia();
            const isLandscape = this.scale.width > this.scale.height;

            const incorrectText = this.add.text(this.scale.width / 2, this.scale.height * (isLandscape ? 0.92 : 0.95) , '‚ùå Respuesta incorrecta. Intenta otra vez.', {
                fontSize: `clamp(${isLandscape ? '13px' : '15px'}, 3.8vw, ${isLandscape ? '17px' : '19px'})`, fill: '#f00'
            }).setOrigin(0.5);
            this.uiElements.push(incorrectText);

            this.time.delayedCall(2000, () => {
                if(this.scene.key === 'TriviaScene') { // Asegurarse que la escena sigue activa
                    this.scene.start('MapScene');
                }
            });
        }
    }
    shutdown() {
        this.scale.off('resize', this.handleResize, this);
    }
}

class BadgeScene extends Phaser.Scene {
    constructor() { super('BadgeScene'); }

    create() {
        document.getElementById('finalLogo').style.display = 'flex';
        const touchControls = document.getElementById('touchControls');
        if (touchControls) touchControls.style.display = 'none';
        this.drawDynamicInsignia(userSession.username);
        this.scale.on('resize', this.handleResize, this);
    }

    handleResize() {
        this.drawDynamicInsignia(userSession.username);
    }

    drawDynamicInsignia(nombre) {
        const canvas = document.getElementById('insigniaCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = () => {
            const container = document.getElementById('finalLogo');
            if (!container) return;
            // Usar el 70% del contenedor para el canvas de la insignia, para dejar algo de margen
            const containerWidth = container.clientWidth * 0.7;
            const containerHeight = container.clientHeight * 0.5; // Un poco menos alto

            const aspectRatio = img.width / img.height;
            let newWidth = containerWidth;
            let newHeight = newWidth / aspectRatio;

            if (newHeight > containerHeight) {
                newHeight = containerHeight;
                newWidth = newHeight * aspectRatio;
            }
            newWidth = Math.min(newWidth, img.width, 350); // M√°ximo de 350px
            newHeight = Math.min(newHeight, img.height, 350);


            canvas.width = newWidth;
            canvas.height = newHeight;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const fontSize = Math.max(10, canvas.width * 0.05);
            ctx.font = `bold ${fontSize}px Segoe UI`;
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.fillText(nombre.toUpperCase(), canvas.width / 2, canvas.height * 0.725);
        };
        img.onerror = () => {
            console.error("No se pudo cargar la imagen de la insignia: assets/insigniaBP.png");
            if(ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "red";
                ctx.font = "14px Segoe UI";
                ctx.textAlign = "center";
                ctx.fillText("Error insignia", canvas.width / 2, canvas.height / 2);
            }
        }
        img.src = 'assets/insigniaBP.png';
    }
     shutdown() {
        this.scale.off('resize', this.handleResize, this);
    }
}


function moveLeft() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode > 0) {
        currentMapScene.currentNode--;
        currentMapScene.moveCharacter();
    }
}

function moveRight() {
    if (currentMapScene && currentMapScene.sys.isActive() && currentMapScene.currentNode < (currentMapScene.modules?.length - 1 || 0)) {
        currentMapScene.currentNode++;
        currentMapScene.moveCharacter();
    }
}

function enterScene() {
    if (currentMapScene && currentMapScene.sys.isActive()) {
        const index = currentMapScene.currentNode;
        const unlocked = index === 0 || userSession?.completedStages?.[index - 1];
        if (unlocked && currentMapScene.scene.key === 'MapScene') {
            const touchControls = document.getElementById('touchControls');
            if (touchControls) touchControls.style.pointerEvents = 'none';

            currentMapScene.scene.start('TriviaScene', { stage: index + 1 });
            setTimeout(() => {
                 if(touchControls) {
                    touchControls.style.pointerEvents = 'auto';
                 }
            }, 500);
        }
    }
}

function startGame() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    if (username === '') {
        usernameInput.style.border = "2px solid red";
        // Peque√±a alerta o mensaje en la UI ser√≠a mejor
        if (!document.getElementById('usernameError')) {
            const errorMsg = document.createElement('p');
            errorMsg.id = 'usernameError';
            errorMsg.textContent = '¬°El nombre no puede estar vac√≠o!';
            errorMsg.style.color = 'red';
            errorMsg.style.fontSize = 'clamp(12px, 3vw, 14px)';
            usernameInput.parentNode.insertBefore(errorMsg, usernameInput.nextSibling);
        }
        return;
    }
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();

    usernameInput.style.border = "none";
    userSession.username = username;
    userSession.completedStages = [false, false, false];
    document.getElementById('loginUI').style.display = 'none';

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: '#000',
        scale: {
            mode: Phaser.Scale.RESIZE,
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        scene: [MapScene, TriviaScene, BadgeScene],
        render: {
            antialias: true,
            pixelArt: false
        }
    };

    if (gameInstance) {
        gameInstance.scene.getScenes(true).forEach(scene => {
            if (scene.sys.isActive() && scene.shutdown) { // Asegurarse que la escena tiene shutdown
                scene.shutdown(); // Llama al shutdown de la escena para limpiar listeners
            }
        });
        gameInstance.destroy(true);
    }
    gameInstance = new Phaser.Game(config);
}

window.addEventListener('resize', () => {
    if (gameInstance && gameInstance.scale && gameInstance.scale.game) {
        gameInstance.scale.resize(window.innerWidth, window.innerHeight);
    }
});

document.addEventListener('DOMContentLoaded', () => {
    // Limpiar mensaje de error si existe al recargar
    const existingError = document.getElementById('usernameError');
    if (existingError) existingError.remove();
});

</script>

</body>
</html>